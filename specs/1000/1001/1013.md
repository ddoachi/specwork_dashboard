---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: "1013" # Numeric ID for stable reference
title: "Warm Storage (SATA) Setup"
type: "task" # prd | epic | feature | task | subtask | bug | spike

# === HIERARCHY ===
parent: "1001" # Parent spec ID
children: [] # Child spec IDs (if any)
epic: "1000" # Root epic ID for this work
domain: "infrastructure" # Business domain

# === WORKFLOW ===
status: "draft" # draft | reviewing | approved | in-progress | testing | done
priority: "medium" # high | medium | low

# === TRACKING ===
created: "2025-08-24" # YYYY-MM-DD
updated: "2025-08-24" # YYYY-MM-DD
due_date: "" # YYYY-MM-DD (optional)
estimated_hours: 3 # Time estimate in hours
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: [] # Must be done before this (spec IDs)
blocks: ["1016"] # This blocks these specs (spec IDs)
related: ["1011", "1014"] # Related but not blocking (spec IDs)

# === IMPLEMENTATION ===
pull_requests: [] # GitHub PR numbers
commits: [] # Key implementation commits
context_file: "" # Implementation journal
files: [
    "/etc/fstab",
    "scripts/setup-sata-storage.sh",
    "scripts/sata-health-check.sh",
    "docs/WARM_STORAGE_SETUP.md",
  ] # Key files to modify

# === METADATA ===
tags: [
    "storage",
    "sata",
    "warm-storage",
    "btrfs",
    "compression",
    "backup",
    "logs",
    "intermediate-storage",
  ] # Searchable tags
effort: "small" # small | medium | large | epic
risk: "low" # low | medium | high

# ============================================================================
---

# Warm Storage (SATA) Setup

## Overview

Configure the intermediate warm storage tier using a 1TB SATA drive with btrfs filesystem for local backups, application logs, and temporary processing files. This tier provides a balance between performance and capacity, serving as a buffer between the high-speed hot storage and the high-capacity cold storage.

The warm storage tier enables efficient daily backup operations, log aggregation with compression, and temporary large file processing without impacting the performance-critical hot storage tier.

## Acceptance Criteria

- [ ] **SATA Drive Preparation**: 1TB SATA drive (/dev/sda2) verified and prepared for btrfs formatting
- [ ] **Btrfs Filesystem**: Optimized btrfs filesystem with zstd:3 compression and autodefrag
- [ ] **Mount Configuration**: Automated mounting at `/data/warm-storage` with compression and performance options
- [ ] **Directory Structure**: Organized directory structure (daily-backups/, logs/, temp-processing/)
- [ ] **Compression Validation**: Verify zstd compression is active and providing space savings
- [ ] **Backup Integration**: Integration points ready for daily backup processes
- [ ] **Log Management**: Log rotation and cleanup policies configured
- [ ] **Health Monitoring**: Basic health check and space monitoring for warm storage

## Technical Approach

### Warm Storage Architecture

Design an efficient intermediate storage layer optimized for:
- **Daily Backups**: Sequential write-optimized for database snapshot operations
- **Log Aggregation**: Compressed storage for application and system logs
- **Temporary Processing**: Workspace for large file operations and data processing
- **Space Efficiency**: Btrfs compression to maximize storage utilization

### Key Components

1. **SATA Drive Configuration**
   - 1TB SATA drive formatted with btrfs for compression benefits
   - Label assignment for easy identification and mounting
   - Optimized for sequential I/O patterns (backups, logs)

2. **Btrfs Optimization**
   - zstd:3 compression for optimal balance of speed and space savings
   - Autodefrag for sustained performance over time
   - Subvolume structure for different data types
   - Snapshot capabilities for point-in-time recovery

3. **Directory Organization**
   ```
   /data/warm-storage/
   ├── daily-backups/         # Database snapshots and automated backups
   ├── logs/                  # Application logs with 30-day retention
   └── temp-processing/       # Temporary large file operations
   ```

### Implementation Steps

1. **SATA Drive Verification and Preparation**
   ```bash
   # Verify SATA drive specifications
   lsblk -o NAME,SIZE,MODEL,TRAN /dev/sda
   
   # Check current partition status
   fdisk -l /dev/sda
   
   # Verify partition 2 is available for formatting
   lsblk /dev/sda2
   ```

2. **Btrfs Filesystem Creation**
   ```bash
   # Format SATA partition with btrfs and compression
   mkfs.btrfs -f -L "jts-warm-storage" \
     -O compress-force=zstd:3 \
     /dev/sda2
   
   # Verify filesystem creation
   btrfs filesystem show /dev/sda2
   ```

3. **Mount Point Configuration**
   ```bash
   # Create mount point
   mkdir -p /data/warm-storage
   
   # Add optimized mount entry to fstab
   echo '/dev/sda2 /data/warm-storage btrfs defaults,compress=zstd:3,autodefrag,noatime 0 2' >> /etc/fstab
   
   # Mount and verify
   mount /data/warm-storage
   mount | grep warm-storage
   ```

4. **Directory Structure Creation**
   ```bash
   # Create organized directory structure
   mkdir -p /data/warm-storage/{daily-backups,logs,temp-processing}
   
   # Set appropriate permissions
   chmod 755 /data/warm-storage
   chmod 755 /data/warm-storage/daily-backups
   chmod 755 /data/warm-storage/logs
   chmod 755 /data/warm-storage/temp-processing
   
   # Create subdirectories for different backup types
   mkdir -p /data/warm-storage/daily-backups/{postgresql,clickhouse,mongodb}
   
   # Create log subdirectories
   mkdir -p /data/warm-storage/logs/{application,system,audit}
   ```

5. **Compression Validation and Optimization**
   ```bash
   # Test compression effectiveness
   dd if=/dev/zero of=/data/warm-storage/compression-test bs=1M count=100
   
   # Check actual disk usage vs file size
   du -sh /data/warm-storage/compression-test
   ls -lh /data/warm-storage/compression-test
   
   # Cleanup test file
   rm /data/warm-storage/compression-test
   
   # Verify compression is active
   btrfs filesystem usage /data/warm-storage
   ```

6. **Integration with System Services**
   ```bash
   # Configure logrotate for warm storage logs
   cat > /etc/logrotate.d/warm-storage << 'EOF'
   /data/warm-storage/logs/*/*.log {
       daily
       missingok
       rotate 30
       compress
       delaycompress
       notifempty
       create 644 root root
   }
   EOF
   
   # Set up automatic cleanup of temp files
   echo '0 2 * * * root find /data/warm-storage/temp-processing -mtime +3 -delete' >> /etc/crontab
   ```

## Dependencies

**No Dependencies**: This feature can be implemented independently of hot storage (1011) and runs in parallel.

**Enables After Implementation:**
- **Feature 1016**: Tiered Storage Management requires warm storage for backup lifecycle operations

## Testing Plan

- **Drive Validation**: Verify SATA drive specifications and partition availability
- **Filesystem Creation**: Test btrfs formatting with compression options
- **Mount Testing**: Confirm filesystem mounts correctly with all optimization options
- **Compression Effectiveness**: Validate zstd compression is working and providing space savings
- **Directory Structure**: Verify proper directory creation and permissions
- **Write Performance**: Test sequential write performance for backup operations
- **Integration Testing**: Ensure integration with system logging and cleanup processes
- **Space Monitoring**: Validate space usage monitoring and alerting

## Claude Code Instructions

```
When implementing warm storage setup:

SATA OPTIMIZATION:
1. SATA drives are optimized for sequential I/O - perfect for backups and logs
2. Use btrfs compression to maximize space efficiency
3. Configure autodefrag to maintain performance over time
4. Set up proper mount options for btrfs optimization

DIRECTORY ORGANIZATION:
1. Create logical separation between backup types
2. Organize logs by source (application, system, audit)
3. Provide workspace for temporary large file operations
4. Set up automated cleanup policies

COMPRESSION STRATEGY:
1. Use zstd:3 for optimal balance of speed and compression ratio
2. Test compression effectiveness with real data samples
3. Monitor compression performance over time
4. Adjust compression level if needed based on performance

INTEGRATION POINTS:
1. This storage tier integrates with backup scripts (Feature 1016)
2. Log management systems will use this storage
3. Temporary processing for data pipeline operations
4. Consider future integration with monitoring systems

INDEPENDENT IMPLEMENTATION:
1. This feature can run in parallel with hot storage setup (1011)
2. No dependencies on NVMe LVM configuration
3. Can be tested and validated independently
4. Provides immediate value for log management
```

## Notes

### Parallel Implementation Benefits
- **Independent Execution**: Can run simultaneously with hot storage setup
- **Immediate Value**: Provides log and backup capabilities immediately
- **Low Risk**: SATA configuration has minimal impact on existing systems
- **Quick Validation**: Simple testing and verification procedures

### Operational Benefits
- **Space Efficiency**: Btrfs compression significantly reduces storage requirements
- **Backup Performance**: Optimized for sequential backup operations
- **Log Management**: Centralized log storage with automated rotation
- **Flexibility**: Btrfs snapshots enable point-in-time recovery

## Status Updates

- **2025-08-24**: Feature specification created as warm storage component extracted from monolithic storage spec