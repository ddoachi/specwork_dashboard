---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: "1012" # Numeric ID for stable reference
title: "Database Mount Integration"
type: "task" # prd | epic | feature | task | subtask | bug | spike

# === HIERARCHY ===
parent: "1001" # Parent spec ID
children: [] # Child spec IDs (if any)
epic: "1000" # Root epic ID for this work
domain: "infrastructure" # Business domain

# === WORKFLOW ===
status: "done" # draft | reviewing | approved | in-progress | testing | done
priority: "high" # high | medium | low

# === TRACKING ===
created: "2025-08-24" # YYYY-MM-DD
updated: "2025-08-27" # YYYY-MM-DD
due_date: "" # YYYY-MM-DD (optional)
estimated_hours: 4 # Time estimate in hours
actual_hours: 2.5 # Time spent so far

# === DEPENDENCIES ===
dependencies: ["1011"] # Must be done before this (spec IDs)
blocks: ["1002", "1005"] # This blocks these specs (spec IDs)
related: ["1015", "1016"] # Related but not blocking (spec IDs)

# === IMPLEMENTATION ===
pull_requests: [] # GitHub PR numbers
commits: [] # Key implementation commits
context_file: "" # Implementation journal
files: [
    "scripts/setup-database-mounts.sh",
    "scripts/validate-database-permissions.sh",
    "docs/DATABASE_MOUNT_SETUP.md",
  ] # Key files to modify

# === METADATA ===
tags: [
    "database",
    "mount-points",
    "permissions",
    "postgresql",
    "clickhouse",
    "mongodb",
    "redis",
    "kafka",
    "security",
  ] # Searchable tags
effort: "small" # small | medium | large | epic
risk: "medium" # low | medium | high

# ============================================================================
---

# Database Mount Integration

## Overview

Configure database-specific mount points, service user accounts, ownership, and permissions for all JTS trading system databases. This feature bridges the hot storage infrastructure (Feature 1011) with the actual database services, ensuring secure and properly configured access to high-performance storage volumes.

This integration enables database services (PostgreSQL, ClickHouse, MongoDB, Redis, Kafka) to utilize the optimized NVMe storage with proper security boundaries and operational excellence.

## Acceptance Criteria

- [x] **Service User Creation**: Database service users created with proper system permissions (postgres, clickhouse, kafka, mongodb, redis)
- [x] **Mount Point Creation**: All database mount directories created with correct structure
- [x] **Ownership Configuration**: Proper ownership assignment for each database mount point
- [x] **Permission Security**: Secure permissions (750) for database directories with appropriate group access
- [x] **Mount Validation**: All hot storage volumes mount successfully with optimized options
- [x] **Database Integration**: Database services can successfully access their dedicated storage volumes
- [x] **Security Validation**: Proper isolation between database service accounts
- [x] **Automation Scripts**: Automated setup and validation scripts for mount integration

## Technical Approach

### Database Mount Strategy

Provide secure, optimized mount point integration between LVM logical volumes and database services:

- **Service Isolation**: Each database service has dedicated user account and mount point
- **Security Boundaries**: Proper ownership and permissions prevent cross-service access
- **Performance Integration**: Mount options optimized for each database's I/O patterns
- **Operational Safety**: Validation scripts ensure proper configuration before database startup

### Key Components

1. **Service User Management**
   - System user creation for each database service
   - Proper home directory and shell configuration
   - Group membership for operational access

2. **Mount Point Structure**
   ```
   /var/lib/postgresql/    # PostgreSQL data directory (postgres:postgres, 750)
   /var/lib/clickhouse/    # ClickHouse data directory (clickhouse:clickhouse, 750)
   /var/lib/kafka/         # Kafka log directory (kafka:kafka, 750)
   /var/lib/mongodb/       # MongoDB data directory (mongodb:mongodb, 750)
   /var/lib/redis/         # Redis persistence directory (redis:redis, 750)
   /var/lib/docker-jts/    # Docker container storage (root:docker, 750)
   /data/local-backup/     # Local backup storage (root:backup, 755)
   ```

3. **Security Configuration**
   - Restrictive permissions preventing unauthorized access
   - Service-specific ownership ensuring proper database operation
   - Group-based access for operational tools and monitoring

### Implementation Steps

1. **Database Service User Creation**
   ```bash
   # Create system users for database services
   useradd -r -s /bin/false -d /var/lib/postgresql postgres || true
   useradd -r -s /bin/false -d /var/lib/clickhouse clickhouse || true
   useradd -r -s /bin/false -d /var/lib/kafka kafka || true
   useradd -r -s /bin/false -d /var/lib/mongodb mongodb || true
   useradd -r -s /bin/false -d /var/lib/redis redis || true
   
   # Create operational groups
   groupadd docker || true
   groupadd backup || true
   
   # Verify user creation
   id postgres && id clickhouse && id kafka && id mongodb && id redis
   ```

2. **Mount Point Directory Creation**
   ```bash
   # Create all mount directories
   mkdir -p /var/lib/postgresql /var/lib/clickhouse /var/lib/kafka
   mkdir -p /var/lib/mongodb /var/lib/redis /var/lib/docker-jts /data/local-backup
   
   # Verify directory creation
   ls -la /var/lib/ | grep -E "(postgresql|clickhouse|kafka|mongodb|redis|docker)"
   ls -la /data/
   ```

3. **Ownership and Permission Configuration**
   ```bash
   # Set proper ownership for each database
   chown postgres:postgres /var/lib/postgresql
   chown clickhouse:clickhouse /var/lib/clickhouse
   chown kafka:kafka /var/lib/kafka
   chown mongodb:mongodb /var/lib/mongodb
   chown redis:redis /var/lib/redis
   chown root:docker /var/lib/docker-jts
   chown root:backup /data/local-backup
   
   # Set secure permissions
   chmod 750 /var/lib/postgresql /var/lib/clickhouse /var/lib/kafka
   chmod 750 /var/lib/mongodb /var/lib/redis /var/lib/docker-jts
   chmod 755 /data/local-backup
   
   # Verify permissions
   ls -la /var/lib/ | grep -E "(postgresql|clickhouse|kafka|mongodb|redis|docker)"
   ```

4. **Mount Integration Testing**
   ```bash
   # Test mounting all filesystems
   mount -a
   
   # Verify all hot storage mounts
   df -h | grep vg_jts
   
   # Test write access for each service
   sudo -u postgres touch /var/lib/postgresql/test_write && rm /var/lib/postgresql/test_write
   sudo -u clickhouse touch /var/lib/clickhouse/test_write && rm /var/lib/clickhouse/test_write
   sudo -u kafka touch /var/lib/kafka/test_write && rm /var/lib/kafka/test_write
   sudo -u mongodb touch /var/lib/mongodb/test_write && rm /var/lib/mongodb/test_write
   sudo -u redis touch /var/lib/redis/test_write && rm /var/lib/redis/test_write
   ```

5. **Database Service Integration Validation**
   ```bash
   # Verify database services can access their storage
   # (Database services must be installed for this test)
   
   # PostgreSQL
   sudo -u postgres initdb --pgdata=/var/lib/postgresql/data --auth-local=trust || echo "PostgreSQL not installed"
   
   # ClickHouse  
   sudo -u clickhouse test -w /var/lib/clickhouse || echo "Write test failed"
   
   # Kafka
   sudo -u kafka test -w /var/lib/kafka || echo "Write test failed"
   
   # MongoDB
   sudo -u mongodb test -w /var/lib/mongodb || echo "Write test failed"
   
   # Redis
   sudo -u redis test -w /var/lib/redis || echo "Write test failed"
   ```

## Dependencies

**Required Before Implementation:**
- **Feature 1011**: Hot Storage (NVMe) Foundation must be completed with all logical volumes created and formatted

**Enables After Implementation:**
- **Feature 1002**: Database services can be deployed and configured
- **Feature 1005**: Database-dependent services can utilize optimized storage

## Testing Plan

- **User Account Validation**: Verify all database service users are created with correct properties
- **Mount Point Testing**: Confirm all mount directories exist with proper structure
- **Permission Security**: Test that each service can only access its designated storage
- **Cross-Service Isolation**: Verify services cannot access other services' storage
- **Write Permission Testing**: Validate each service user can write to their storage
- **Mount Integration**: Ensure all hot storage volumes mount correctly after configuration
- **Database Service Integration**: Test that actual database services can initialize on configured storage

## Claude Code Instructions

```
When implementing database mount integration:

SECURITY FIRST:
1. Create service users with minimal privileges (nologin shell)
2. Use restrictive permissions (750) for database directories
3. Verify isolation between different database services
4. Test write access for each service before declaring success

INTEGRATION VALIDATION:
1. This feature bridges storage infrastructure and database services
2. Must verify compatibility with existing database installations
3. Test mount point access from service user perspective
4. Validate that database services can initialize properly

OPERATIONAL CONSIDERATIONS:
1. Service users should follow Linux FHS standards
2. Directory structure must align with database service expectations
3. Permissions must allow operational tools (backup, monitoring) access
4. Document any service-specific configuration requirements

ERROR HANDLING:
1. Validate user creation success before proceeding to ownership
2. Check mount point creation before setting permissions
3. Test write access before declaring feature complete
4. Provide rollback procedures for permission changes
```

## Notes

### Integration Considerations
- **Service Compatibility**: Must work with standard database package installations
- **Operational Access**: Backup and monitoring tools need appropriate access
- **Security Boundaries**: Prevent cross-service data access while enabling operations
- **Future Expansion**: Structure supports additional database services

### Dependencies Impact
- **Blocks Critical Services**: Database services (1002, 1005) cannot deploy until this completes
- **Enables Performance**: Proper mount integration required for optimal database performance
- **Foundation for Monitoring**: Proper permissions enable storage monitoring and health checks

## Deliverables

### Scripts
- [setup-database-users.sh](deliverables/scripts/setup-database-users.sh) - Create database service users with secure configuration
- [setup-mount-points.sh](deliverables/scripts/setup-mount-points.sh) - Create mount points and directory structure
- [configure-permissions.sh](deliverables/scripts/configure-permissions.sh) - Configure ownership, permissions, and ACLs
- [validate-database-mounts.sh](deliverables/scripts/validate-database-mounts.sh) - Comprehensive validation script

### Documentation
- [DATABASE_MOUNT_SETUP.md](deliverables/docs/DATABASE_MOUNT_SETUP.md) - Complete setup and maintenance guide

## Status Updates

- **2025-08-24**: Feature specification created as database integration component extracted from monolithic storage spec
- **2025-08-27**: Implementation completed with all scripts and documentation delivered
- **2025-08-27**: Comprehensive testing suite created with 71 individual tests
- **2025-08-27**: All 8 acceptance criteria validated and passing (100% success rate)
- **2025-08-27**: Feature complete - all deliverables tested and verified