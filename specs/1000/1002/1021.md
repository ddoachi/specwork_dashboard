---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1021'
title: 'Node.js and Yarn Environment Setup'
type: 'task'

# === HIERARCHY ===
parent: '1002'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'high'

# === TRACKING ===
created: '2025-08-27'
updated: '2025-08-27'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === DEPENDENCIES ===
dependencies: [] # Must be done first - foundation for all other tasks
blocks: ['1022', '1023', '1024', '1025', '1026']
related: []

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1021.context.md"
files: ['scripts/install-node-yarn.sh', 'package.json', '.yarnrc.yml', '.gitignore']

# === METADATA ===
tags: ['nodejs', 'yarn', 'package-manager', 'setup']
effort: 'small'
risk: 'low'

# ============================================================================
---

# Node.js and Yarn Environment Setup

## Overview

Install and configure Node.js 20 LTS and Yarn 4 (Berry) as the foundation for the JTS development environment. This task establishes the runtime and package management system for all TypeScript/NestJS microservices.

## Acceptance Criteria

- [ ] Node.js 20 LTS installed on Linux and Windows (WSL2)
- [ ] Yarn 4 (Berry) configured as primary package manager
- [ ] Corepack enabled for Yarn management
- [ ] Package.json with workspace configuration
- [ ] `.yarnrc.yml` with project settings
- [ ] Installation scripts for both platforms
- [ ] Yarn workspace structure initialized
- [ ] Git ignore patterns for Yarn

## Technical Approach

### Installation Scripts

**Linux Installation** (`scripts/install-node-yarn-linux.sh`):
```bash
#!/bin/bash
# Install Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# Enable Corepack for Yarn
corepack enable

# Install Yarn 4 (Berry)
yarn set version stable

# Verify installations
node --version
yarn --version
```

**Windows Installation** (`scripts/install-node-yarn-windows.ps1`):
```powershell
# Install Node.js via Chocolatey
choco install nodejs-lts -y

# Enable Corepack
corepack enable

# Set Yarn to stable version
corepack prepare yarn@stable --activate

# Verify installations
node --version
yarn --version
```

### Yarn Configuration

**`.yarnrc.yml`**:
```yaml
nodeLinker: node-modules
enableGlobalCache: false
npmRegistryServer: "https://registry.npmjs.org"

# Workspace settings
nmMode: hardlinks-local
compressionLevel: mixed

# Plugin configuration
plugins:
  - path: .yarn/plugins/@yarnpkg/plugin-workspace-tools.cjs
    spec: "@yarnpkg/plugin-workspace-tools"
```

### Package.json Setup

```json
{
  "name": "jts-monorepo",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "libs/*"
  ],
  "packageManager": "yarn@4.0.0",
  "engines": {
    "node": ">=20.0.0",
    "yarn": ">=4.0.0"
  },
  "scripts": {
    "setup": "yarn install && yarn prepare",
    "prepare": "husky install"
  }
}
```

## Implementation Steps

1. **Platform Detection** (30 min)
   - Create unified setup script
   - Detect OS and route to appropriate installer
   - Handle WSL2 detection on Windows

2. **Node.js Installation** (30 min)
   - Install Node.js 20 LTS
   - Configure npm registry
   - Set up global npm config

3. **Yarn 4 Setup** (30 min)
   - Enable Corepack
   - Install Yarn Berry
   - Configure `.yarnrc.yml`

4. **Workspace Configuration** (30 min)
   - Initialize monorepo structure
   - Configure workspaces in package.json
   - Set up Yarn plugins

## Deliverables

- `scripts/install-node-yarn.sh` - Unified installation script
- `scripts/install-node-yarn-linux.sh` - Linux-specific installer
- `scripts/install-node-yarn-windows.ps1` - Windows PowerShell installer
- `.yarnrc.yml` - Yarn configuration
- `package.json` - Root package configuration
- Installation verification checklist

## Testing Plan

- Test installation on fresh Ubuntu 22.04
- Test installation on Windows 11 with WSL2
- Verify Node.js version is 20.x
- Verify Yarn version is 4.x
- Test workspace resolution
- Verify package installation works

## Notes

- Yarn 4 uses Plug'n'Play by default, but we use node-modules for compatibility
- Corepack is the official way to manage Yarn versions
- This task must be completed before any other development tasks