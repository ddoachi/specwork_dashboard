---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1026'
title: 'Development Scripts and Automation'
type: 'task'

# === HIERARCHY ===
parent: '1002'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'medium'

# === TRACKING ===
created: '2025-08-27'
updated: '2025-08-27'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === DEPENDENCIES ===
dependencies: ['1021', '1022', '1023', '1024', '1025'] # Needs all other components
blocks: []
related: []

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1026.context.md"
files: ['scripts/setup-dev-env.sh', 'scripts/health-check.js', 'package.json', 'docs/DEVELOPMENT.md']

# === METADATA ===
tags: ['automation', 'scripts', 'developer-experience', 'documentation']
effort: 'medium'
risk: 'low'

# ============================================================================
---

# Development Scripts and Automation

## Overview

Create comprehensive automation scripts and documentation to streamline the development workflow. This includes the master setup script, service management utilities, health checks, and complete developer onboarding documentation.

## Acceptance Criteria

- [ ] Master setup script for complete environment initialization
- [ ] Service health check and monitoring scripts
- [ ] Database migration and seeding automation
- [ ] Development workflow scripts in package.json
- [ ] Troubleshooting utilities
- [ ] Complete developer onboarding guide
- [ ] Platform-specific setup documentation
- [ ] Quick start guide for new developers

## Technical Approach

### Master Setup Script (`scripts/setup-dev-env.sh`)

```bash
#!/bin/bash
set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ Setting up JTS Development Environment${NC}"
echo "================================================"

# Detect OS
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS="linux"
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
        OS="windows"
    else
        echo -e "${RED}‚ùå Unsupported OS: $OSTYPE${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Detected OS: $OS${NC}"
}

# Check prerequisites
check_prerequisites() {
    echo -e "\n${YELLOW}üìã Checking prerequisites...${NC}"
    
    # Check Node.js
    if ! command -v node &> /dev/null; then
        echo -e "${RED}‚ùå Node.js is not installed${NC}"
        echo "Please run: ./scripts/install-node-yarn.sh"
        exit 1
    fi
    
    NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
    if [ "$NODE_VERSION" -lt 20 ]; then
        echo -e "${RED}‚ùå Node.js 20+ required (found: $(node -v))${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Node.js $(node -v)${NC}"
    
    # Check Yarn
    if ! command -v yarn &> /dev/null; then
        echo -e "${RED}‚ùå Yarn is not installed${NC}"
        echo "Please run: corepack enable && yarn set version stable"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Yarn $(yarn -v)${NC}"
    
    # Check Docker
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}‚ùå Docker is not installed${NC}"
        echo "Please install Docker Desktop or Docker Engine"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Docker $(docker -v)${NC}"
    
    # Check Git
    if ! command -v git &> /dev/null; then
        echo -e "${RED}‚ùå Git is not installed${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Git $(git --version)${NC}"
}

# Install dependencies
install_dependencies() {
    echo -e "\n${YELLOW}üì¶ Installing dependencies...${NC}"
    yarn install
    echo -e "${GREEN}‚úÖ Dependencies installed${NC}"
}

# Setup environment
setup_environment() {
    echo -e "\n${YELLOW}üîß Setting up environment...${NC}"
    
    if [ ! -f .env.local ]; then
        cp .env.example .env.local
        echo -e "${GREEN}‚úÖ Created .env.local from template${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  Please update .env.local with your credentials${NC}"
    else
        echo -e "${GREEN}‚úÖ .env.local already exists${NC}"
    fi
    
    # Validate environment
    node scripts/validate-env.js
}

# Start Docker services
start_services() {
    echo -e "\n${YELLOW}üê≥ Starting Docker services...${NC}"
    docker-compose -f docker-compose.dev.yml up -d
    
    echo "Waiting for services to be ready..."
    sleep 10
    
    # Check service health
    node scripts/check-services-health.js
    echo -e "${GREEN}‚úÖ All services are running${NC}"
}

# Run database migrations
run_migrations() {
    echo -e "\n${YELLOW}üóÑÔ∏è Running database migrations...${NC}"
    
    # PostgreSQL migrations
    yarn db:migrate:postgres || echo -e "${YELLOW}‚ö†Ô∏è  PostgreSQL migration skipped${NC}"
    
    # ClickHouse setup
    yarn db:migrate:clickhouse || echo -e "${YELLOW}‚ö†Ô∏è  ClickHouse setup skipped${NC}"
    
    echo -e "${GREEN}‚úÖ Database migrations complete${NC}"
}

# Seed development data
seed_data() {
    echo -e "\n${YELLOW}üå± Seeding development data...${NC}"
    
    read -p "Do you want to seed development data? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        yarn db:seed
        echo -e "${GREEN}‚úÖ Development data seeded${NC}"
    else
        echo "Skipping data seeding"
    fi
}

# Setup VS Code
setup_vscode() {
    echo -e "\n${YELLOW}üìù Setting up VS Code...${NC}"
    
    if command -v code &> /dev/null; then
        read -p "Install recommended VS Code extensions? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            cat .vscode/extensions.json | grep -Po '"[^"]*"' | xargs -I {} code --install-extension {}
            echo -e "${GREEN}‚úÖ VS Code extensions installed${NC}"
        fi
    else
        echo "VS Code CLI not found, skipping extension installation"
    fi
}

# Setup git hooks
setup_git_hooks() {
    echo -e "\n${YELLOW}ü™ù Setting up Git hooks...${NC}"
    yarn prepare
    echo -e "${GREEN}‚úÖ Git hooks configured${NC}"
}

# Print summary
print_summary() {
    echo -e "\n${GREEN}‚úÖ Development environment setup complete!${NC}"
    echo "================================================"
    echo -e "\nüìö ${YELLOW}Next steps:${NC}"
    echo "  1. Update .env.local with your credentials"
    echo "  2. Start development: yarn services:start"
    echo "  3. View logs: yarn dev:logs"
    echo "  4. Open http://localhost:3000"
    echo ""
    echo -e "üìñ ${YELLOW}Useful commands:${NC}"
    echo "  yarn dev:status   - Check service status"
    echo "  yarn dev:stop     - Stop all services"
    echo "  yarn dev:clean    - Reset everything"
    echo "  yarn test         - Run tests"
    echo "  yarn lint         - Run linter"
    echo ""
    echo -e "üîó ${YELLOW}Service URLs:${NC}"
    echo "  API Gateway:  http://localhost:3000"
    echo "  Kafka UI:     http://localhost:8080"
    echo "  pgAdmin:      http://localhost:5050"
    echo "  Grafana:      http://localhost:3100"
    echo ""
    echo "Happy coding! üöÄ"
}

# Main execution
main() {
    detect_os
    check_prerequisites
    install_dependencies
    setup_environment
    start_services
    run_migrations
    seed_data
    setup_vscode
    setup_git_hooks
    print_summary
}

# Run main function
main
```

### Service Health Check (`scripts/check-services-health.js`)

```javascript
const { exec } = require('child_process');
const { promisify } = require('util');
const execAsync = promisify(exec);

const services = [
  { name: 'PostgreSQL', container: 'jts-postgres-dev', port: 5432 },
  { name: 'ClickHouse', container: 'jts-clickhouse-dev', port: 8123 },
  { name: 'MongoDB', container: 'jts-mongodb-dev', port: 27017 },
  { name: 'Redis', container: 'jts-redis-dev', port: 6379 },
  { name: 'Kafka', container: 'jts-kafka-dev', port: 9092 },
];

async function checkService(service) {
  try {
    // Check if container is running
    const { stdout } = await execAsync(
      `docker ps --filter "name=${service.container}" --format "{{.Status}}"`
    );
    
    if (!stdout.includes('Up')) {
      return { ...service, status: 'down', error: 'Container not running' };
    }
    
    // Check port accessibility
    const portCheck = await execAsync(
      `nc -zv localhost ${service.port} 2>&1`
    ).catch(() => ({ stdout: '' }));
    
    if (portCheck.stdout.includes('succeeded') || portCheck.stdout.includes('open')) {
      return { ...service, status: 'healthy' };
    }
    
    return { ...service, status: 'unhealthy', error: 'Port not accessible' };
  } catch (error) {
    return { ...service, status: 'error', error: error.message };
  }
}

async function checkAllServices() {
  console.log('üè• Checking service health...\n');
  
  const results = await Promise.all(services.map(checkService));
  
  results.forEach(result => {
    const icon = result.status === 'healthy' ? '‚úÖ' : '‚ùå';
    console.log(`${icon} ${result.name}: ${result.status}`);
    if (result.error) {
      console.log(`   Error: ${result.error}`);
    }
  });
  
  const allHealthy = results.every(r => r.status === 'healthy');
  
  if (!allHealthy) {
    console.log('\n‚ö†Ô∏è  Some services are not healthy');
    console.log('Run: yarn dev:logs to check container logs');
    process.exit(1);
  }
  
  console.log('\n‚úÖ All services are healthy!');
}

checkAllServices().catch(console.error);
```

### Updated Package.json Scripts

```json
{
  "scripts": {
    "setup": "./scripts/setup-dev-env.sh",
    "dev:setup": "yarn setup",
    "dev:start": "docker-compose -f docker-compose.dev.yml up -d",
    "dev:stop": "docker-compose -f docker-compose.dev.yml down",
    "dev:restart": "yarn dev:stop && yarn dev:start",
    "dev:clean": "docker-compose -f docker-compose.dev.yml down -v --remove-orphans",
    "dev:logs": "docker-compose -f docker-compose.dev.yml logs -f",
    "dev:status": "docker-compose -f docker-compose.dev.yml ps",
    "dev:health": "node scripts/check-services-health.js",
    
    "db:migrate": "yarn db:migrate:postgres && yarn db:migrate:clickhouse",
    "db:migrate:postgres": "yarn prisma migrate deploy",
    "db:migrate:clickhouse": "node scripts/migrate-clickhouse.js",
    "db:seed": "yarn db:seed:postgres && yarn db:seed:clickhouse",
    "db:seed:postgres": "yarn prisma db seed",
    "db:seed:clickhouse": "node scripts/seed-clickhouse.js",
    "db:reset": "yarn dev:clean && yarn dev:start && sleep 10 && yarn db:migrate && yarn db:seed",
    
    "services:start": "concurrently \"yarn start:gateway\" \"yarn start:strategy\" \"yarn start:risk\"",
    "start:gateway": "nx serve api-gateway",
    "start:strategy": "nx serve strategy-engine",
    "start:risk": "nx serve risk-management",
    "start:order": "nx serve order-execution",
    "start:market-data": "nx serve market-data-collector",
    
    "test": "nx run-many --target=test --all",
    "test:affected": "nx affected --target=test",
    "test:watch": "nx run-many --target=test --all --watch",
    
    "build": "nx run-many --target=build --all",
    "build:affected": "nx affected --target=build",
    
    "lint": "nx run-many --target=lint --all --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "type-check": "tsc --noEmit"
  }
}
```

## Implementation Steps

1. **Create Setup Script** (45 min)
   - Master setup automation
   - OS detection
   - Prerequisite checking
   - Interactive prompts

2. **Create Health Check** (30 min)
   - Service monitoring
   - Port checking
   - Status reporting

3. **Update Package.json** (30 min)
   - Add all workflow scripts
   - Organize by category
   - Add descriptions

4. **Write Documentation** (45 min)
   - Developer onboarding guide
   - Troubleshooting guide
   - Quick start tutorial

5. **Test Complete Flow** (30 min)
   - Run on fresh system
   - Verify all steps work
   - Document any issues

## Deliverables

- `scripts/setup-dev-env.sh` - Master setup script
- `scripts/check-services-health.js` - Health monitoring
- `scripts/validate-env.js` - Environment validator
- Updated `package.json` - All workflow scripts
- `docs/DEVELOPMENT.md` - Complete developer guide
- `docs/QUICKSTART.md` - 5-minute setup guide

## Testing Plan

- Test setup on fresh Linux system
- Test setup on Windows with WSL2
- Verify all services start correctly
- Test health check accuracy
- Validate all package.json scripts
- Time the complete setup process

## Notes

- Setup should be idempotent (safe to run multiple times)
- Provide clear error messages and solutions
- Make the process as automated as possible
- Consider creating a setup video tutorial