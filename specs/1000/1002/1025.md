---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1025'
title: 'Code Quality Tools and Git Hooks'
type: 'task'

# === HIERARCHY ===
parent: '1002'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'medium'

# === TRACKING ===
created: '2025-08-27'
updated: '2025-08-27'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === DEPENDENCIES ===
dependencies: ['1021', '1022'] # Needs Node.js and VS Code
blocks: ['1026']
related: []

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1025.context.md"
files: ['.eslintrc.js', '.prettierrc', '.pre-commit-config.yaml', 'husky/', 'lint-staged.config.js']

# === METADATA ===
tags: ['eslint', 'prettier', 'husky', 'pre-commit', 'code-quality']
effort: 'small'
risk: 'low'

# ============================================================================
---

# Code Quality Tools and Git Hooks

## Overview

Set up comprehensive code quality tooling including ESLint, Prettier, Husky, and pre-commit hooks to ensure consistent code style and catch issues before commits. Configure for TypeScript/NestJS development with Nx monorepo structure.

## Acceptance Criteria

- [ ] ESLint configured for TypeScript/NestJS
- [ ] Prettier configured with team standards
- [ ] Husky pre-commit hooks installed
- [ ] Lint-staged for selective file checking
- [ ] Pre-commit configuration for Python hooks
- [ ] Type checking in pre-commit
- [ ] Test execution on pre-push
- [ ] Commit message validation

## Technical Approach

### ESLint Configuration (`.eslintrc.js`)

```javascript
module.exports = {
  root: true,
  parser: '@typescript-eslint/parser',
  parserOptions: {
    project: 'tsconfig.json',
    tsconfigRootDir: __dirname,
    sourceType: 'module',
  },
  plugins: ['@typescript-eslint', 'import', 'jest'],
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:@typescript-eslint/recommended-requiring-type-checking',
    'plugin:jest/recommended',
    'prettier',
  ],
  env: {
    node: true,
    jest: true,
  },
  ignorePatterns: ['.eslintrc.js', 'dist/', 'node_modules/', 'coverage/'],
  rules: {
    '@typescript-eslint/interface-name-prefix': 'off',
    '@typescript-eslint/explicit-function-return-type': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    '@typescript-eslint/no-explicit-any': 'error',
    '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
    'import/order': [
      'error',
      {
        groups: ['builtin', 'external', 'internal', 'parent', 'sibling', 'index'],
        'newlines-between': 'always',
        alphabetize: { order: 'asc' },
      },
    ],
  },
};
```

### Prettier Configuration (`.prettierrc`)

```json
{
  "semi": true,
  "trailingComma": "all",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "arrowParens": "always",
  "endOfLine": "lf",
  "bracketSpacing": true,
  "jsxBracketSameLine": false
}
```

### Husky Configuration

```bash
# Install and initialize Husky
yarn add -D husky
yarn husky install

# Add to package.json scripts
"prepare": "husky install"
```

**Pre-commit Hook** (`.husky/pre-commit`):
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

yarn lint-staged
```

**Pre-push Hook** (`.husky/pre-push`):
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

yarn test:affected
```

**Commit Message Hook** (`.husky/commit-msg`):
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

yarn commitlint --edit $1
```

### Lint-staged Configuration (`lint-staged.config.js`)

```javascript
module.exports = {
  '*.{ts,tsx}': [
    'eslint --fix',
    'prettier --write',
    'jest --bail --findRelatedTests',
  ],
  '*.{js,jsx}': [
    'eslint --fix',
    'prettier --write',
  ],
  '*.{json,md,yml,yaml}': [
    'prettier --write',
  ],
  '*.sql': [
    'prettier --write --parser sql',
  ],
};
```

### Commitlint Configuration (`.commitlintrc.js`)

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',     // New feature
        'fix',      // Bug fix
        'docs',     // Documentation
        'style',    // Formatting
        'refactor', // Code change that neither fixes a bug nor adds a feature
        'perf',     // Performance improvement
        'test',     // Adding tests
        'chore',    // Maintenance
        'revert',   // Revert previous commit
        'build',    // Build system changes
        'ci',       // CI configuration
      ],
    ],
    'subject-case': [2, 'always', 'sentence-case'],
    'header-max-length': [2, 'always', 100],
  },
};
```

### Pre-commit Python Configuration (`.pre-commit-config.yaml`)

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=500']
      - id: detect-private-key

  - repo: local
    hooks:
      - id: eslint
        name: ESLint
        entry: yarn eslint --fix
        language: node
        types: [javascript, typescript]
        require_serial: true

      - id: prettier
        name: Prettier
        entry: yarn prettier --write
        language: node
        types_or: [javascript, typescript, json, yaml, markdown]

      - id: type-check
        name: TypeScript Type Check
        entry: yarn type-check
        language: node
        pass_filenames: false
        types: [typescript]
```

### Package.json Scripts

```json
{
  "scripts": {
    "prepare": "husky install",
    "lint": "eslint \"{apps,libs}/**/*.ts\" --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "lint:check": "eslint \"{apps,libs}/**/*.ts\"",
    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "type-check": "tsc --noEmit",
    "test:affected": "nx affected --target=test",
    "pre-commit": "lint-staged",
    "commitlint": "commitlint"
  }
}
```

## Implementation Steps

1. **Install Dependencies** (30 min)
   - ESLint and TypeScript plugins
   - Prettier and integrations
   - Husky and lint-staged
   - Commitlint

2. **Configure Linters** (30 min)
   - Set up ESLint rules
   - Configure Prettier
   - Integrate with VS Code

3. **Set Up Git Hooks** (30 min)
   - Initialize Husky
   - Create hook scripts
   - Configure lint-staged

4. **Test Configuration** (30 min)
   - Test pre-commit hooks
   - Verify formatting
   - Check commit validation

## Deliverables

- `.eslintrc.js` - ESLint configuration
- `.prettierrc` - Prettier configuration
- `.husky/` - Git hooks directory
- `lint-staged.config.js` - Staged file linting
- `.commitlintrc.js` - Commit message rules
- `.pre-commit-config.yaml` - Additional hooks

## Testing Plan

- Make test commits with various file types
- Verify ESLint catches issues
- Test Prettier formatting
- Validate commit message enforcement
- Check pre-push test execution
- Verify type checking works

## Notes

- Hooks should be fast to avoid developer friction
- Consider using --no-verify flag documentation for emergencies
- Pre-push hooks run affected tests only for speed