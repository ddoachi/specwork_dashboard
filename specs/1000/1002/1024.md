---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1024'
title: 'Environment Configuration and Secrets Management'
type: 'task'

# === HIERARCHY ===
parent: '1002'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'high'

# === TRACKING ===
created: '2025-08-27'
updated: '2025-08-27'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === DEPENDENCIES ===
dependencies: ['1023'] # Needs services to be configured
blocks: ['1025', '1026']
related: []

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1024.context.md"
files: ['.env.example', '.gitignore', 'scripts/setup-env.sh', 'docs/ENVIRONMENT.md']

# === METADATA ===
tags: ['environment', 'secrets', 'configuration', 'security']
effort: 'small'
risk: 'medium'

# ============================================================================
---

# Environment Configuration and Secrets Management

## Overview

Implement the two-file environment strategy (.env.example + .env.local) with secure credential management for Creon batch scripts and multi-account KIS configuration. Ensure all sensitive data is properly protected and never committed to version control.

## Acceptance Criteria

- [ ] `.env.example` template with dummy values created
- [ ] Documentation for `.env.local` setup
- [ ] Secure Creon credential storage structure
- [ ] Multi-account KIS configuration (2 accounts)
- [ ] Git ignore patterns for sensitive files
- [ ] Environment validation script
- [ ] Setup script for initial configuration
- [ ] Clear documentation for all environment variables

## Technical Approach

### Environment Template (`.env.example`)

```env
# ============================================================
# JTS Development Environment Configuration Template
# Copy this file to .env.local and add your actual credentials
# .env.local is gitignored and should never be committed
# ============================================================

# === Application Configuration ===
NODE_ENV=development
PORT=3000
API_VERSION=v1

# === Database URLs (Local Development) ===
DATABASE_URL=postgresql://jts_admin:dev_password@localhost:5432/jts_trading_dev
CLICKHOUSE_URL=http://jts_ch:dev_password@localhost:8123/jts_market_data_dev
MONGODB_URL=mongodb://jts_mongo:dev_password@localhost:27017/jts_config_dev
REDIS_URL=redis://localhost:6379

# === Kafka Configuration ===
KAFKA_BROKERS=localhost:9092
KAFKA_CLIENT_ID=jts-dev
KAFKA_GROUP_ID=jts-trading-dev

# === JWT Configuration (Development) ===
JWT_SECRET=your-dev-jwt-secret-key-change-this
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# === Creon Configuration (Windows Only) ===
CREON_SCRIPT_PATH=/secure/creon/scripts/creon-launcher.bat
CREON_CREDENTIALS_PATH=/secure/creon/credentials/
CREON_LOG_PATH=/secure/creon/logs/

# === KIS Multi-Account Configuration ===
# Account 1 - Primary (Large Cap Focus)
KIS_ACCOUNT_1_ID=KIS_001
KIS_ACCOUNT_1_APPKEY=your_kis_appkey_1_here
KIS_ACCOUNT_1_APPSECRET=your_kis_appsecret_1_here
KIS_ACCOUNT_1_NUMBER=your_account_number_1

# Account 2 - Secondary (Mid Cap Focus)
KIS_ACCOUNT_2_ID=KIS_002
KIS_ACCOUNT_2_APPKEY=your_kis_appkey_2_here
KIS_ACCOUNT_2_APPSECRET=your_kis_appsecret_2_here
KIS_ACCOUNT_2_NUMBER=your_account_number_2

# === Rate Limiting Configuration ===
RATE_LIMIT_WINDOW=60000
RATE_LIMIT_MAX_REQUESTS=1000

# KIS Rate Limits (per account)
KIS_RATE_LIMIT_PER_ACCOUNT_PER_SECOND=20
KIS_RATE_LIMIT_PER_ACCOUNT_PER_15SEC=60
KIS_TOTAL_ACCOUNTS=2

# === Logging Configuration ===
LOG_LEVEL=debug
LOG_FORMAT=combined

# === Development Features ===
ENABLE_SWAGGER=true
ENABLE_DEBUG_ROUTES=true
ENABLE_MOCK_DATA=true

# === External APIs (Crypto - Optional) ===
BINANCE_API_KEY=your_binance_key_here
BINANCE_SECRET_KEY=your_binance_secret_here
UPBIT_ACCESS_KEY=your_upbit_access_here
UPBIT_SECRET_KEY=your_upbit_secret_here
```

### Secure Creon Storage Structure

```bash
# Directory structure for secure Creon credentials
/secure/creon/
├── credentials/
│   ├── .gitkeep
│   └── README.md         # Instructions for credential setup
├── scripts/
│   ├── creon-launcher.bat
│   ├── encrypt-credentials.ps1
│   └── decrypt-and-run.ps1
└── logs/
    └── .gitkeep
```

### Environment Setup Script (`scripts/setup-env.sh`)

```bash
#!/bin/bash
set -e

echo "🔧 Setting up JTS environment configuration..."

# Check if .env.local exists
if [ -f .env.local ]; then
    echo "⚠️  .env.local already exists. Skipping creation."
else
    echo "📝 Creating .env.local from template..."
    cp .env.example .env.local
    echo "✅ .env.local created. Please update with your actual credentials."
fi

# Create secure directories for Creon (Windows only)
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
    echo "🔒 Setting up secure Creon directories..."
    mkdir -p /secure/creon/{credentials,scripts,logs}
    
    # Set restricted permissions
    chmod 700 /secure/creon/credentials
    
    echo "📋 Creon directories created. Add your credentials to /secure/creon/credentials/"
fi

# Validate environment
echo "🔍 Validating environment configuration..."
node scripts/validate-env.js

echo "✅ Environment setup complete!"
```

### Environment Validation (`scripts/validate-env.js`)

```javascript
const fs = require('fs');
const path = require('path');

function validateEnv() {
  const envPath = path.join(__dirname, '..', '.env.local');
  
  if (!fs.existsSync(envPath)) {
    console.error('❌ .env.local not found. Run: cp .env.example .env.local');
    process.exit(1);
  }
  
  // Check for placeholder values
  const content = fs.readFileSync(envPath, 'utf8');
  const warnings = [];
  
  if (content.includes('your_kis_appkey_1_here')) {
    warnings.push('KIS Account 1 credentials not configured');
  }
  
  if (content.includes('your_kis_appkey_2_here')) {
    warnings.push('KIS Account 2 credentials not configured');
  }
  
  if (content.includes('your-dev-jwt-secret-key-change-this')) {
    warnings.push('JWT secret not changed from default');
  }
  
  if (warnings.length > 0) {
    console.log('⚠️  Environment warnings:');
    warnings.forEach(w => console.log(`   - ${w}`));
  } else {
    console.log('✅ Environment configuration looks good!');
  }
}

validateEnv();
```

### Updated `.gitignore`

```gitignore
# Environment files
.env.local
.env.*.local

# Secure credentials
/secure/creon/credentials/*
!/secure/creon/credentials/.gitkeep
!/secure/creon/credentials/README.md

# Logs
*.log
/secure/creon/logs/*
!/secure/creon/logs/.gitkeep
```

## Implementation Steps

1. **Create Environment Template** (30 min)
   - Create comprehensive `.env.example`
   - Document all variables
   - Add placeholder values

2. **Set Up Secure Storage** (30 min)
   - Create Creon directory structure
   - Set proper permissions
   - Add credential encryption scripts

3. **Create Setup Scripts** (30 min)
   - Environment setup script
   - Validation script
   - Helper utilities

4. **Documentation** (30 min)
   - Environment setup guide
   - Security best practices
   - Troubleshooting guide

## Deliverables

- `.env.example` - Complete environment template
- `scripts/setup-env.sh` - Environment setup script
- `scripts/validate-env.js` - Validation utility
- `/secure/creon/` - Secure credential structure
- `docs/ENVIRONMENT.md` - Environment documentation
- Updated `.gitignore` - Security patterns

## Testing Plan

- Test environment setup on fresh system
- Verify `.env.local` creation
- Validate gitignore patterns work
- Test credential encryption/decryption
- Verify validation script catches issues
- Check multi-account configuration

## Notes

- Never commit .env.local or any file with real credentials
- Creon credentials require special handling on Windows
- KIS accounts can scale to 3 in production