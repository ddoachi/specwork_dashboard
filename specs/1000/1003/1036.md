---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: '1036' # Numeric ID for stable reference
title: 'Configure CI/CD Pipeline and Automation'
type: 'task' # prd | epic | feature | task | subtask | bug | spike
category: 'infrastructure'

# === HIERARCHY ===
parent: '1003' # Parent spec ID
children: [] # Child spec IDs (if any)
epic: '1000' # Root epic ID for this work
domain: 'infrastructure' # Business domain

# === WORKFLOW ===
status: 'draft' # draft | reviewing | approved | in-progress | testing | done
priority: 'medium' # high | medium | low
assignee: '' # Who's working on this
reviewer: '' # Who should review (optional)

# === TRACKING ===
created: '2025-08-28' # YYYY-MM-DD
updated: '2025-08-28' # YYYY-MM-DD
due_date: '' # YYYY-MM-DD (optional)
estimated_hours: 2 # Time estimate in hours
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: ['1035'] # Must be done before this (spec IDs)
blocks: [] # This blocks these specs
related: [] # Related but not blocking (spec IDs)

# === IMPLEMENTATION ===
pull_requests: [] # GitHub PR numbers
commits: [] # Key implementation commits
context_file: "1003.context.md" # Implementation journal
worktree: '' # Worktree path (optional)
files: ['.github/workflows/ci.yml', '.github/workflows/deploy.yml', '.github/dependabot.yml'] # Key files to modify

# === METADATA ===
tags: ['ci', 'cd', 'github-actions', 'automation', 'deployment'] # Searchable tags
effort: 'small' # small | medium | large | epic
risk: 'low' # low | medium | high

# ============================================================================
---

# Task 1036: Configure CI/CD Pipeline and Automation

## Overview

Set up GitHub Actions workflows for continuous integration with affected builds and tests, configure automated dependency review and security scanning, implement build artifact management, and prepare deployment pipelines for production readiness.

## Acceptance Criteria

- [ ] CI pipeline runs on all PRs and main branch pushes
- [ ] Affected builds and tests execute efficiently
- [ ] Code coverage reports to Codecov
- [ ] Security scanning integrated
- [ ] Build artifacts properly managed
- [ ] Deployment workflow prepared

## Technical Details

### 1. Main CI Workflow

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  NX_CLOUD_DISTRIBUTED_EXECUTION: false
  NX_DAEMON: false

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      affected-apps: ${{ steps.affected.outputs.apps }}
      affected-libs: ${{ steps.affected.outputs.libs }}
      has-affected: ${{ steps.affected.outputs.has-affected }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx
          key: ${{ runner.os }}-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Calculate Affected
        id: affected
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            NX_BASE=${{ github.event.pull_request.base.sha }}
          else
            NX_BASE=$(git rev-parse HEAD~1)
          fi
          
          AFFECTED_APPS=$(npx nx print-affected --base=$NX_BASE --head=HEAD --select=projects --type=app)
          AFFECTED_LIBS=$(npx nx print-affected --base=$NX_BASE --head=HEAD --select=projects --type=lib)
          HAS_AFFECTED=$(npx nx print-affected --base=$NX_BASE --head=HEAD --select=projects | grep -q '.' && echo 'true' || echo 'false')
          
          echo "apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT
          echo "libs=$AFFECTED_LIBS" >> $GITHUB_OUTPUT
          echo "has-affected=$HAS_AFFECTED" >> $GITHUB_OUTPUT

  lint:
    name: Lint
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx
          key: ${{ runner.os }}-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run Lint
        run: npx nx affected --target=lint --base=${{ github.event.pull_request.base.sha || 'HEAD~1' }} --parallel=3

  type-check:
    name: Type Check
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx
          key: ${{ runner.os }}-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run Type Check
        run: npx nx affected --target=type-check --base=${{ github.event.pull_request.base.sha || 'HEAD~1' }} --parallel=3

  test:
    name: Test
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx
          key: ${{ runner.os }}-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run Tests
        run: npx nx affected --target=test --base=${{ github.event.pull_request.base.sha || 'HEAD~1' }} --parallel=3 --configuration=ci --coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          directory: ./coverage
          fail_ci_if_error: false
          verbose: true

  build:
    name: Build
    needs: [lint, type-check, test]
    if: always() && needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx
          key: ${{ runner.os }}-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build Affected
        run: npx nx affected --target=build --base=${{ github.event.pull_request.base.sha || 'HEAD~1' }} --parallel=3 --configuration=production

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
```

### 2. Deployment Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      service:
        description: 'Service to deploy (leave empty for all)'
        required: false
        type: string

env:
  NODE_VERSION: '20.x'
  REGISTRY: ghcr.io

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.list }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Services
        id: services
        run: |
          if [ -z "${{ inputs.service }}" ]; then
            SERVICES=$(ls apps/ | jq -R -s -c 'split("\n")[:-1]')
          else
            SERVICES='["${{ inputs.service }}"]'
          fi
          echo "list=$SERVICES" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and Push Images
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.services) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build Service
        run: npx nx build ${{ matrix.service }} --configuration=production

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:${{ inputs.environment }}

  deploy:
    name: Deploy to ${{ inputs.environment }}
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Deploy to Kubernetes
        run: |
          echo "Deploying to ${{ inputs.environment }}"
          # Add actual deployment commands here
```

### 3. Dependabot Configuration

```yaml
# .github/dependabot.yml
version: 2
updates:
  # NPM dependencies
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "03:00"
    open-pull-requests-limit: 10
    groups:
      nx:
        patterns:
          - "@nx/*"
          - "nx"
      nestjs:
        patterns:
          - "@nestjs/*"
      testing:
        patterns:
          - "jest*"
          - "@types/jest"
          - "@swc/*"
      linting:
        patterns:
          - "eslint*"
          - "@typescript-eslint/*"
          - "prettier"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5

  # Docker
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
```

### 4. Code Quality Workflow

```yaml
# .github/workflows/code-quality.yml
name: Code Quality

on:
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
```

### 5. Release Workflow

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
```

## Implementation Steps

1. **Create CI workflow** (30 min)
   - Set up main CI pipeline
   - Configure affected builds
   - Add coverage reporting

2. **Add security scanning** (20 min)
   - Configure Trivy scanner
   - Set up dependency review
   - Add CodeQL analysis

3. **Create deployment workflow** (30 min)
   - Set up build and push
   - Configure environment deployment
   - Add rollback capabilities

4. **Configure Dependabot** (15 min)
   - Set up dependency updates
   - Configure grouping
   - Set schedules

5. **Add quality checks** (25 min)
   - Configure SonarCloud
   - Set up CodeQL
   - Add release automation

## Testing

```bash
# Test workflow syntax
act -l

# Run workflow locally (requires act)
act push

# Validate workflow files
npx action-validator .github/workflows/*.yml

# Test affected calculation
npx nx print-affected --base=main --head=HEAD
```

## Success Metrics

- CI pipeline runs in <5 minutes for affected builds
- Zero security vulnerabilities in dependencies
- 100% of PRs pass quality gates
- Deployment time <10 minutes
- Rollback capability within 2 minutes

## Notes

- Use affected builds to optimize CI time
- Cache aggressively to speed up workflows
- Implement proper secrets management
- Consider matrix builds for parallel execution
- Monitor workflow performance and optimize