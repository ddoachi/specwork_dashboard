---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: '1033' # Numeric ID for stable reference
title: 'Set Up Build and Testing Infrastructure'
type: 'task' # prd | epic | feature | task | subtask | bug | spike
category: 'infrastructure'

# === HIERARCHY ===
parent: '1003' # Parent spec ID
children: [] # Child spec IDs (if any)
epic: '1000' # Root epic ID for this work
domain: 'infrastructure' # Business domain

# === WORKFLOW ===
status: 'draft' # draft | reviewing | approved | in-progress | testing | done
priority: 'high' # high | medium | low
assignee: '' # Who's working on this
reviewer: '' # Who should review (optional)

# === TRACKING ===
created: '2025-08-28' # YYYY-MM-DD
updated: '2025-08-28' # YYYY-MM-DD
due_date: '' # YYYY-MM-DD (optional)
estimated_hours: 2.5 # Time estimate in hours
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: ['1032'] # Must be done before this (spec IDs)
blocks: ['1035', '1036'] # This blocks these specs
related: ['1034'] # Related but not blocking (spec IDs)

# === IMPLEMENTATION ===
pull_requests: [] # GitHub PR numbers
commits: [] # Key implementation commits
context_file: "1003.context.md" # Implementation journal
worktree: '' # Worktree path (optional)
files: ['jest.config.ts', 'jest.preset.js', 'nx.json', 'tools/test-setup.ts'] # Key files to modify

# === METADATA ===
tags: ['testing', 'jest', 'build', 'coverage', 'quality'] # Searchable tags
effort: 'small' # small | medium | large | epic
risk: 'low' # low | medium | high

# ============================================================================
---

# Task 1033: Set Up Build and Testing Infrastructure

## Overview

Configure Jest testing framework with coverage reporting, set up optimized build configuration with Nx caching, and implement dependency boundary enforcement to maintain architectural integrity.

## Acceptance Criteria

- [ ] Jest configured with 95% coverage threshold
- [ ] Build targets optimized with caching
- [ ] Parallel test execution enabled
- [ ] Coverage reporting integrated
- [ ] Test utilities and common setup configured
- [ ] Dependency boundaries enforced

## Technical Details

### 1. Jest Configuration

```typescript
// jest.config.ts
import { getJestProjects } from '@nx/jest';

export default {
  projects: getJestProjects(),
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'apps/**/*.ts',
    'libs/**/*.ts',
    '!**/*.spec.ts',
    '!**/*.e2e-spec.ts',
    '!**/node_modules/**',
    '!**/dist/**',
    '!**/*.d.ts',
    '!**/main.ts',
    '!**/test-setup.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95
    }
  },
  testMatch: [
    '<rootDir>/{apps,libs}/**/*(*.)@(spec|test).[jt]s?(x)'
  ],
  transform: {
    '^.+\\.[jt]s$': ['@swc/jest', {
      jsc: {
        parser: {
          syntax: 'typescript',
          decorators: true
        },
        transform: {
          legacyDecorator: true,
          decoratorMetadata: true
        }
      }
    }]
  },
  moduleNameMapper: {
    '^@jts/(.*)$': '<rootDir>/libs/$1/src'
  },
  setupFilesAfterEnv: ['<rootDir>/tools/test-setup.ts'],
  testEnvironment: 'node',
  maxWorkers: '50%',
  verbose: true
};
```

### 2. Jest Preset

```javascript
// jest.preset.js
const nxPreset = require('@nx/jest/preset').default;

module.exports = {
  ...nxPreset,
  coverageReporters: ['text', 'html', 'cobertura'],
  testTimeout: 10000,
  clearMocks: true,
  restoreMocks: true
};
```

### 3. Test Setup

```typescript
// tools/test-setup.ts
import 'reflect-metadata';

// Global test utilities
global.beforeEach(() => {
  jest.clearAllMocks();
});

// Mock common dependencies
jest.mock('@jts/infrastructure/logging', () => ({
  Logger: jest.fn().mockImplementation(() => ({
    log: jest.fn(),
    error: jest.fn(),
    warn: jest.fn(),
    debug: jest.fn()
  }))
}));

// Test helpers
export const createMockService = <T>(service: new (...args: any[]) => T): jest.Mocked<T> => {
  const mockService = {} as jest.Mocked<T>;
  Object.getOwnPropertyNames(service.prototype).forEach(name => {
    if (name !== 'constructor') {
      mockService[name] = jest.fn();
    }
  });
  return mockService;
};
```

### 4. Build Configuration Updates

```json
// nx.json additions
{
  "targetDefaults": {
    "build": {
      "dependsOn": ["^build"],
      "inputs": ["production", "^production"],
      "cache": true,
      "options": {
        "outputPath": "dist/{projectRoot}",
        "main": "{projectRoot}/src/main.ts",
        "tsConfig": "{projectRoot}/tsconfig.app.json"
      }
    },
    "test": {
      "inputs": ["default", "^production", "{workspaceRoot}/jest.preset.js"],
      "cache": true,
      "options": {
        "passWithNoTests": true,
        "jestConfig": "{projectRoot}/jest.config.ts"
      },
      "configurations": {
        "ci": {
          "ci": true,
          "coverage": true,
          "coverageReporters": ["text", "cobertura"]
        }
      }
    }
  },
  "namedInputs": {
    "default": ["{projectRoot}/**/*", "sharedGlobals"],
    "production": [
      "default",
      "!{projectRoot}/**/?(*.)+(spec|test).[jt]s?(x)?(.snap)",
      "!{projectRoot}/tsconfig.spec.json",
      "!{projectRoot}/jest.config.[jt]s",
      "!{projectRoot}/**/*.stories.@(js|jsx|ts|tsx|mdx)"
    ],
    "sharedGlobals": [
      "{workspaceRoot}/jest.preset.js",
      "{workspaceRoot}/jest.config.ts",
      "{workspaceRoot}/tsconfig.base.json"
    ]
  }
}
```

### 5. Dependency Boundaries

```json
// nx.json enforcement rules
{
  "@nx/enforce-module-boundaries": [
    "error",
    {
      "enforceBuildableLibDependency": true,
      "allow": [],
      "depConstraints": [
        {
          "sourceTag": "scope:shared",
          "onlyDependOnLibsWithTags": ["scope:shared"]
        },
        {
          "sourceTag": "scope:domain",
          "onlyDependOnLibsWithTags": ["scope:shared", "scope:domain"]
        },
        {
          "sourceTag": "scope:infrastructure",
          "onlyDependOnLibsWithTags": ["scope:shared", "scope:domain", "scope:infrastructure"]
        },
        {
          "sourceTag": "scope:brokers",
          "onlyDependOnLibsWithTags": ["scope:shared", "scope:domain", "scope:infrastructure"]
        },
        {
          "sourceTag": "scope:apps",
          "onlyDependOnLibsWithTags": ["*"]
        }
      ]
    }
  ]
}
```

## Implementation Steps

1. **Configure Jest** (45 min)
   - Create jest.config.ts with coverage settings
   - Set up jest.preset.js with common configuration
   - Configure transform options for TypeScript

2. **Create test utilities** (30 min)
   - Implement test-setup.ts with global utilities
   - Create mock factories for common services
   - Add test helper functions

3. **Update build configuration** (30 min)
   - Configure Nx build targets
   - Set up caching options
   - Define named inputs for optimization

4. **Set up coverage reporting** (30 min)
   - Configure coverage thresholds
   - Set up coverage reporters
   - Create coverage collection rules

5. **Implement dependency boundaries** (15 min)
   - Define module boundary rules
   - Configure enforcement in nx.json
   - Test boundary violations

## Testing

```bash
# Run all tests
nx run-many --target=test --all

# Run tests with coverage
nx run-many --target=test --all --coverage

# Run tests in CI mode
nx run-many --target=test --all --configuration=ci

# Test specific project
nx test shared-utils

# Run affected tests
nx affected:test

# Check coverage report
open coverage/index.html
```

## Success Metrics

- All tests pass with >95% coverage
- Test execution time <30 seconds for unit tests
- Build caching reduces rebuild time by >70%
- No dependency boundary violations
- Coverage reports generated automatically

## Notes

- Use SWC for faster TypeScript compilation
- Configure parallel execution for speed
- Implement test categorization (unit/integration/e2e)
- Consider test data factories for complex objects
- Set up continuous monitoring of coverage metrics