---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1041'
title: 'GitHub Actions Workflow Structure Setup'
type: 'task'

# === HIERARCHY ===
parent: '1004'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'high'

# === TRACKING ===
created: '2025-08-28'
updated: '2025-08-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === DEPENDENCIES ===
dependencies: [] # Foundation task - must be done first
blocks: ['1042', '1043', '1044', '1047', '1048', '1049']
related: ['1003'] # Monorepo structure

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1041.context.md"
files: ['.github/workflows/', '.github/dependabot.yml', '.github/CODEOWNERS']

# === METADATA ===
tags: ['github-actions', 'cicd', 'workflow', 'automation']
effort: 'small'
risk: 'low'

# ============================================================================
---

# GitHub Actions Workflow Structure Setup

## Overview

Set up the foundational GitHub Actions workflow structure for the JTS CI/CD pipeline. This task establishes the `.github/workflows` directory structure, common workflow templates, reusable actions, and basic configuration files that all other workflows will build upon.

## Acceptance Criteria

- [ ] **Workflow Directory Structure**: `.github/workflows/` directory created with organized structure
- [ ] **Reusable Workflows**: Common workflow templates for shared steps
- [ ] **Environment Configuration**: GitHub environment secrets and variables setup
- [ ] **Workflow Permissions**: Proper GITHUB_TOKEN permissions configured
- [ ] **Caching Strategy**: Centralized cache configuration for Node modules and Nx
- [ ] **Matrix Strategy**: Template for parallel job execution
- [ ] **Concurrency Controls**: Prevent duplicate workflow runs
- [ ] **Dependabot Configuration**: Automated dependency updates

## Technical Implementation

### Directory Structure

```
.github/
├── workflows/
│   ├── _templates/           # Reusable workflow templates
│   │   ├── setup.yml         # Common setup steps
│   │   ├── cache.yml         # Caching configuration
│   │   └── notify.yml        # Notification template
│   ├── ci.yml                # Main CI pipeline
│   ├── security.yml          # Security scanning
│   ├── deploy-dev.yml        # Development deployment
│   ├── deploy-staging.yml    # Staging deployment
│   ├── deploy-production.yml # Production deployment
│   ├── release.yml           # Release management
│   ├── cleanup.yml           # Environment cleanup
│   └── performance.yml       # Performance testing
├── dependabot.yml            # Dependency update configuration
├── CODEOWNERS               # Code ownership rules
└── actions/                 # Custom composite actions
    ├── setup-node/
    │   └── action.yml
    └── nx-affected/
        └── action.yml
```

### Reusable Setup Workflow

**`.github/workflows/_templates/setup.yml`**:
```yaml
name: Reusable Setup Workflow

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '20.x'
      checkout-depth:
        required: false
        type: number
        default: 0
    outputs:
      cache-key:
        description: "Node modules cache key"
        value: ${{ jobs.setup.outputs.cache-key }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.checkout-depth }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      
      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      
      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      
      - name: Install Dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline
```

### Custom Composite Actions

**`.github/actions/setup-node/action.yml`**:
```yaml
name: 'Setup Node Environment'
description: 'Setup Node.js with caching and Nx configuration'

inputs:
  node-version:
    description: 'Node.js version'
    required: false
    default: '20.x'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'
    
    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          .nx/cache
        key: deps-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          deps-${{ runner.os }}-
    
    - name: Install Dependencies
      shell: bash
      run: |
        npm ci --prefer-offline
        npx nx reset
```

### Workflow Templates

**Concurrency Template**:
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
```

**Environment Variables Template**:
```yaml
env:
  NODE_VERSION: '20.x'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_BRANCH: ${{ github.event.number || github.ref_name }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
```

### Dependabot Configuration

**`.github/dependabot.yml`**:
```yaml
version: 2
updates:
  # Node.js dependencies
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "03:00"
    reviewers:
      - "core-team"
    labels:
      - "dependencies"
      - "javascript"
    open-pull-requests-limit: 10
    groups:
      production:
        dependency-type: "production"
      development:
        dependency-type: "development"
        patterns:
          - "@types/*"
          - "eslint*"
          - "prettier*"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    reviewers:
      - "devops-team"
    labels:
      - "dependencies"
      - "github-actions"
```

### Code Owners Configuration

**`.github/CODEOWNERS`**:
```
# Global owners
* @core-team

# CI/CD Pipeline
/.github/ @devops-team
/Dockerfile @devops-team
/docker-compose*.yml @devops-team

# Core services
/apps/api-gateway/ @backend-team
/apps/strategy-engine/ @algo-team
/apps/risk-management/ @risk-team
/apps/order-execution/ @trading-team

# Infrastructure
/infrastructure/ @devops-team
/scripts/ @devops-team

# Documentation
/docs/ @tech-writers
*.md @tech-writers
```

## Testing Plan

- Validate workflow syntax using GitHub's workflow linter
- Test reusable workflows with sample projects
- Verify caching improves build times
- Test concurrency controls with multiple PRs
- Validate Dependabot creates PRs correctly

## Success Metrics

- All workflows pass syntax validation
- Caching reduces dependency installation time by >50%
- Reusable workflows reduce code duplication by >70%
- Dependabot successfully manages dependencies

## Notes

- Use workflow_call for maximum reusability
- Implement proper secret management from day one
- Consider workflow visualization tools for complex pipelines
- Document all custom actions thoroughly