---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: '1004' # Numeric ID for stable reference
title: 'CI/CD Pipeline Foundation'
type: 'feature' # prd | epic | feature | task | subtask | bug | spike

# === HIERARCHY ===
parent: '1000' # Parent spec ID (leave empty for top-level)
children: ['1041', '1042', '1043', '1044', '1045', '1046', '1047', '1048', '1049', '1050', '1051'] # Task breakdowns
epic: '1000' # Root epic ID for this work
domain: 'infrastructure' # Business domain

# === WORKFLOW ===
status: 'draft' # draft | reviewing | approved | in-progress | testing | done
priority: 'high' # high | medium | low

# === TRACKING ===
created: '2025-08-24' # YYYY-MM-DD
updated: '2025-08-24' # YYYY-MM-DD
due_date: '' # YYYY-MM-DD (optional)
estimated_hours: 21 # Time estimate in hours (sum of all tasks)
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: ['1003'] # Must be done before this (spec IDs)
blocks: ['1005', '1006', '1007', '1008'] # This blocks these specs
related: ['1002'] # Related but not blocking (spec IDs)

# === IMPLEMENTATION ===
pull_requests: [] # GitHub PR numbers
commits: [] # Key implementation commits
context_file: "context.md" # Implementation journal
files: ['.github/workflows/', 'Dockerfile', 'docker-compose.ci.yml', 'package.json', 'nx.json', 'jest.config.ts', '.dockerignore', 'scripts/'] # Key files to modify

# === METADATA ===
tags: ['cicd', 'github-actions', 'docker', 'automation', 'testing', 'deployment', 'security'] # Searchable tags
effort: 'medium' # small | medium | large | epic
risk: 'medium' # low | medium | high

# ============================================================================
---

# CI/CD Pipeline Foundation

## Overview

Establish a comprehensive CI/CD pipeline foundation using GitHub Actions for the JTS automated trading system. This feature implements automated build processes, comprehensive testing workflows, Docker containerization, security scanning, and deployment pipelines. The pipeline ensures code quality, security, and reliable deployments across development, staging, and production environments.

## Acceptance Criteria

- [ ] **GitHub Actions Workflows**: Complete CI/CD pipeline with matrix builds, parallel execution, and caching
- [ ] **Build Automation**: Automated builds for all services with Nx affected builds and Docker multi-stage builds
- [ ] **Test Automation**: Comprehensive testing including unit, integration, e2e tests with 95% coverage requirement
- [ ] **Security Scanning**: SAST, dependency scanning, container vulnerability scanning, and secrets detection
- [ ] **Docker Registry**: Automated Docker image building, tagging, and pushing to container registry
- [ ] **Deployment Pipeline**: Blue-green deployments with rollback capabilities and environment promotion
- [ ] **Quality Gates**: Code coverage thresholds, security gates, and performance benchmarks
- [ ] **Notifications**: Slack/Discord integration for build status, deployments, and failures
- [ ] **Branch Protection**: Protected main branch with required status checks and code review
- [ ] **Release Management**: Semantic versioning, automated changelog generation, and GitHub releases

## Technical Approach

### CI/CD Architecture

#### Pipeline Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GitHub Actions Pipeline                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Code Quality  â”‚     Security    â”‚     Build       â”‚   Deployment  â”‚
â”‚                 â”‚                 â”‚                 â”‚               â”‚
â”‚  â€¢ Linting      â”‚  â€¢ SAST Scan    â”‚  â€¢ Nx Affected  â”‚  â€¢ Dev Deploy â”‚
â”‚  â€¢ Format Check â”‚  â€¢ Dependency   â”‚  â€¢ Docker Build â”‚  â€¢ Staging    â”‚
â”‚  â€¢ Type Check   â”‚    Scan         â”‚  â€¢ Registry     â”‚  â€¢ Production â”‚
â”‚  â€¢ Unit Tests   â”‚  â€¢ Secret Scan  â”‚    Push         â”‚  â€¢ Rollback   â”‚
â”‚  â€¢ E2E Tests    â”‚  â€¢ Container    â”‚  â€¢ Artifacts    â”‚  â€¢ Monitoring â”‚
â”‚  â€¢ Coverage     â”‚    Scan         â”‚    Upload       â”‚  â€¢ Alerts     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Workflow Structure
```
.github/workflows/
â”œâ”€â”€ ci.yml                    # Main CI pipeline
â”œâ”€â”€ security.yml              # Security scanning
â”œâ”€â”€ deploy-dev.yml            # Development deployment
â”œâ”€â”€ deploy-staging.yml        # Staging deployment
â”œâ”€â”€ deploy-production.yml     # Production deployment
â”œâ”€â”€ release.yml               # Release management
â”œâ”€â”€ cleanup.yml               # Environment cleanup
â”œâ”€â”€ performance.yml           # Performance testing
â””â”€â”€ dependency-update.yml     # Automated dependency updates
```

### Core CI/CD Workflows

#### 1. Main CI Pipeline (`.github/workflows/ci.yml`)

```yaml
name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_BRANCH: ${{ github.event.number || github.ref_name }}
  NX_CLOUD_DISTRIBUTED_EXECUTION: true
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  setup:
    name: Setup and Cache
    runs-on: ubuntu-latest
    outputs:
      has-affected: ${{ steps.affected.outputs.has-affected }}
      affected-apps: ${{ steps.affected.outputs.affected-apps }}
      affected-libs: ${{ steps.affected.outputs.affected-libs }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "key=node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install Dependencies
        run: npm ci --prefer-offline

      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Check Affected
        id: affected
        run: |
          AFFECTED_APPS=$(npx nx show projects --affected --type=app --base=origin/main~1 | tr '\n' ',' | sed 's/,$//')
          AFFECTED_LIBS=$(npx nx show projects --affected --type=lib --base=origin/main~1 | tr '\n' ',' | sed 's/,$//')
          HAS_AFFECTED=$([ -n "$AFFECTED_APPS" ] || [ -n "$AFFECTED_LIBS" ] && echo 'true' || echo 'false')
          
          echo "affected-apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT
          echo "affected-libs=$AFFECTED_LIBS" >> $GITHUB_OUTPUT
          echo "has-affected=$HAS_AFFECTED" >> $GITHUB_OUTPUT
          
          echo "Affected Apps: $AFFECTED_APPS"
          echo "Affected Libs: $AFFECTED_LIBS"
          echo "Has Affected: $HAS_AFFECTED"

  code-quality:
    name: Code Quality
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [lint, type-check, format]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Run Lint
        if: matrix.check == 'lint'
        run: npx nx affected --target=lint --parallel=3 --base=origin/main~1

      - name: Run Type Check
        if: matrix.check == 'type-check'
        run: npx nx affected --target=type-check --parallel=3 --base=origin/main~1

      - name: Check Format
        if: matrix.check == 'format'
        run: npx prettier --check .

  test:
    name: Test
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: jts_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Run Unit Tests
        if: matrix.test-type == 'unit'
        run: npx nx affected --target=test --configuration=ci --parallel=3 --base=origin/main~1 --coverage

      - name: Run Integration Tests
        if: matrix.test-type == 'integration'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: npx nx affected --target=integration-test --parallel=2 --base=origin/main~1

      - name: Run E2E Tests
        if: matrix.test-type == 'e2e'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: npx nx affected --target=e2e --parallel=1 --base=origin/main~1

      - name: Upload Coverage Reports
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          directory: ./coverage
          flags: ${{ matrix.test-type }}
          fail_ci_if_error: false

      - name: Coverage Quality Gate
        if: matrix.test-type == 'unit'
        run: |
          COVERAGE=$(grep -o '"pct":[0-9.]*' coverage/coverage-summary.json | head -1 | grep -o '[0-9.]*')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below required 95%"
            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets requirement"
          fi

  build:
    name: Build
    needs: [setup, code-quality, test]
    if: always() && needs.setup.outputs.has-affected == 'true' && needs.code-quality.result == 'success' && needs.test.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['api-gateway', 'strategy-engine', 'risk-management', 'order-execution', 'market-data-collector', 'web-app']
    outputs:
      image-tags: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore Nx Cache
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Build Service
        run: npx nx build ${{ matrix.service }} --configuration=production

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64,linux/arm64

  security-scan:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['api-gateway', 'strategy-engine', 'risk-management', 'order-execution', 'market-data-collector', 'web-app']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

  deployment-ready:
    name: Deployment Ready
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Deployment Ready
        run: |
          echo "ðŸš€ All services built and scanned successfully"
          echo "âœ… Ready for deployment to environments"
```

#### 2. Security Scanning Pipeline (`.github/workflows/security.yml`)

```yaml
name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  sast-scan:
    name: SAST Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: typescript, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Audit Dependencies
        run: npm audit --audit-level moderate

      - name: OSCS Scan
        uses: actions/oscs/scan@v1
        with:
          token: ${{ secrets.OSCS_TOKEN }}
```

#### 3. Deployment Pipeline (`.github/workflows/deploy-production.yml`)

```yaml
name: Production Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        default: 'latest'

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  pre-deployment:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Health Check Production
        run: |
          curl -f https://api.jts.trading/health || echo "Service might be down"

  database-migration:
    name: Database Migration
    needs: pre-deployment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-deployment.outputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Run Database Migrations
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: npm run db:migrate

  blue-green-deployment:
    name: Blue-Green Deployment
    needs: [pre-deployment, database-migration]
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        service: ['api-gateway', 'strategy-engine', 'risk-management', 'order-execution', 'market-data-collector']
    steps:
      - name: Deploy to Green Environment
        run: |
          # Deploy new version to green environment
          kubectl set image deployment/${{ matrix.service }}-green \
            ${{ matrix.service }}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ needs.pre-deployment.outputs.version }} \
            --namespace=production-green

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/${{ matrix.service }}-green --namespace=production-green --timeout=300s

      - name: Health Check Green Environment
        run: |
          # Perform health checks on green environment
          curl -f https://green.api.jts.trading/health

      - name: Switch Traffic to Green
        run: |
          # Switch traffic from blue to green
          kubectl patch service ${{ matrix.service }}-service \
            -p '{"spec":{"selector":{"version":"green"}}}' \
            --namespace=production

      - name: Monitor Deployment
        run: |
          sleep 30
          curl -f https://api.jts.trading/health

  post-deployment:
    name: Post-deployment
    needs: blue-green-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Smoke Tests
        run: |
          # Run critical smoke tests
          curl -f https://api.jts.trading/api/v1/status
          curl -f https://api.jts.trading/api/v1/markets/health

      - name: Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ Production deployment successful!"
          # Send success notification to Slack/Discord

      - name: Rollback on Failure
        if: failure()
        run: |
          # Rollback to blue environment
          kubectl patch service api-gateway-service \
            -p '{"spec":{"selector":{"version":"blue"}}}' \
            --namespace=production
          echo "ðŸ”¥ Deployment failed, rolled back to previous version"
```

### Docker Configuration

#### Multi-stage Dockerfile Template

```dockerfile
# apps/api-gateway/Dockerfile
ARG NODE_VERSION=20-alpine

# Build stage
FROM node:${NODE_VERSION} AS builder
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY nx.json ./
COPY tsconfig.base.json ./

# Install dependencies
RUN npm ci --only=production && npm cache clean --force

# Copy source code
COPY apps/api-gateway ./apps/api-gateway
COPY libs ./libs

# Build the application
RUN npx nx build api-gateway --configuration=production

# Production stage
FROM node:${NODE_VERSION} AS production
WORKDIR /app

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nestjs -u 1001

# Copy built application
COPY --from=builder --chown=nestjs:nodejs /app/dist/apps/api-gateway ./
COPY --from=builder --chown=nestjs:nodejs /app/node_modules ./node_modules

# Security: Remove unnecessary packages
RUN apk del --purge wget curl && \
    rm -rf /var/cache/apk/*

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node health-check.js

# Switch to non-root user
USER nestjs

EXPOSE 3000

CMD ["node", "main.js"]
```

#### Docker Compose for CI

```yaml
# docker-compose.ci.yml
version: '3.8'

services:
  postgres-test:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: jts_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5432:5432"
    tmpfs:
      - /var/lib/postgresql/data
    command: postgres -c fsync=off -c synchronous_commit=off -c full_page_writes=off

  redis-test:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    tmpfs:
      - /data

  clickhouse-test:
    image: clickhouse/clickhouse-server:23.8-alpine
    environment:
      CLICKHOUSE_DB: jts_test_data
      CLICKHOUSE_USER: test_user
      CLICKHOUSE_PASSWORD: test_password
    ports:
      - "8123:8123"
      - "9000:9000"
    tmpfs:
      - /var/lib/clickhouse

  mongodb-test:
    image: mongo:7.0-jammy
    environment:
      MONGO_INITDB_ROOT_USERNAME: test_user
      MONGO_INITDB_ROOT_PASSWORD: test_password
      MONGO_INITDB_DATABASE: jts_test_config
    ports:
      - "27017:27017"
    tmpfs:
      - /data/db

  kafka-test:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper-test
    tmpfs:
      - /var/lib/kafka/data

  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    tmpfs:
      - /var/lib/zookeeper/data
      - /var/lib/zookeeper/log
```

### Quality Gates and Policies

#### Branch Protection Rules

```yaml
# .github/branch-protection-config.yml
protection_rules:
  main:
    required_status_checks:
      strict: true
      contexts:
        - "CI Pipeline / Code Quality (lint)"
        - "CI Pipeline / Code Quality (type-check)"
        - "CI Pipeline / Code Quality (format)"
        - "CI Pipeline / Test (unit)"
        - "CI Pipeline / Test (integration)"
        - "CI Pipeline / Test (e2e)"
        - "CI Pipeline / Build"
        - "CI Pipeline / Security Scan"
    enforce_admins: true
    required_pull_request_reviews:
      required_approving_review_count: 2
      dismiss_stale_reviews: true
      require_code_owner_reviews: true
    restrictions:
      users: []
      teams: ["core-developers"]
```

#### Code Coverage Configuration

```javascript
// jest.config.coverage.js
module.exports = {
  collectCoverageFrom: [
    'apps/**/*.ts',
    'libs/**/*.ts',
    '!**/*.spec.ts',
    '!**/*.e2e-spec.ts',
    '!**/node_modules/**',
    '!**/dist/**',
    '!**/*.d.ts',
    '!**/main.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95,
    },
    './apps/': {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95,
    },
    './libs/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90,
    },
  },
  coverageReporters: [
    'text',
    'text-summary',
    'html',
    'lcov',
    'clover',
    'json-summary',
  ],
};
```

### Performance and Monitoring

#### Performance Testing Workflow

```yaml
# .github/workflows/performance.yml
name: Performance Testing

on:
  schedule:
    - cron: '0 1 * * *'  # Daily at 1 AM
  workflow_dispatch:

jobs:
  api-performance:
    name: API Performance Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          curl -s https://github.com/grafana/k6/releases/download/v0.46.0/k6-v0.46.0-linux-amd64.tar.gz | tar xz
          sudo mv k6-v0.46.0-linux-amd64/k6 /usr/local/bin/

      - name: Run Performance Tests
        run: |
          k6 run --out json=performance-results.json tools/performance/api-load-test.js

      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results.json

  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        run: npx nx build web-app

      - name: Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
```

### Release Management

#### Semantic Release Configuration

```json
{
  "branches": [
    "main",
    {
      "name": "develop",
      "prerelease": "beta"
    }
  ],
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    [
      "@semantic-release/changelog",
      {
        "changelogFile": "CHANGELOG.md"
      }
    ],
    [
      "@semantic-release/npm",
      {
        "npmPublish": false
      }
    ],
    [
      "@semantic-release/github",
      {
        "assets": [
          {
            "path": "dist/**/*.tgz",
            "label": "Distribution Archive"
          }
        ]
      }
    ],
    [
      "@semantic-release/git",
      {
        "assets": [
          "CHANGELOG.md",
          "package.json",
          "package-lock.json"
        ],
        "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
      }
    ]
  ]
}
```

## Implementation Tasks

The feature has been broken down into the following implementation tasks:

### 1. [Task 1041: GitHub Actions Workflow Structure Setup](1041.md)
**Estimated: 2 hours**
- Set up workflow directory structure and templates
- Configure reusable workflows and composite actions
- Establish caching strategy and environment configuration

### 2. [Task 1042: Main CI Pipeline Configuration](1042.md)
**Estimated: 3 hours**
- Implement comprehensive CI workflow with Nx affected detection
- Configure parallel execution for quality checks and tests
- Set up coverage gates and build validation

### 3. [Task 1043: Security Scanning Workflows](1043.md)
**Estimated: 2 hours**
- Configure SAST with CodeQL analysis
- Implement dependency and secret scanning
- Set up container vulnerability scanning with Trivy

### 4. [Task 1044: Deployment Pipeline Workflows](1044.md)
**Estimated: 3 hours**
- Create environment-specific deployment workflows
- Implement blue-green deployment strategy
- Configure rollback mechanisms and health checks

### 5. [Task 1045: Docker Multi-stage Build Configuration](1045.md)
**Estimated: 2 hours**
- Create optimized multi-stage Dockerfiles
- Implement security hardening and non-root users
- Optimize layer caching and image sizes

### 6. [Task 1046: Docker Compose CI Testing Environment](1046.md)
**Estimated: 2 hours**
- Configure Docker Compose for CI testing
- Set up test databases and message queues
- Optimize for fast startup and teardown

### 7. [Task 1047: Test Automation and Coverage Configuration](1047.md)
**Estimated: 3 hours**
- Configure Jest for unit, integration, and E2E tests
- Implement 95% coverage requirements
- Set up test reports and parallel execution

### 8. [Task 1048: Performance Testing Workflow](1048.md)
**Estimated: 2 hours**
- Implement k6 for API load testing
- Configure Lighthouse for frontend audits
- Set up performance budgets and alerts

### 9. [Task 1049: Release Management and Semantic Versioning](1049.md)
**Estimated: 1 hour**
- Configure semantic-release for versioning
- Set up automated changelog generation
- Implement GitHub release creation

### 10. [Task 1050: Branch Protection and Quality Gates](1050.md)
**Estimated: 1 hour**
- Configure branch protection rules
- Set up required status checks and reviews
- Implement CODEOWNERS for automatic assignments

### 11. [Task 1051: CI/CD Monitoring and Notifications](1051.md)
**Estimated: 2 hours**
- Integrate Slack/Discord notifications
- Configure build status reporting
- Set up PR comment integration

**Total Estimated Time: 21 hours**

## Dependencies

- **1003**: Monorepo Structure and Tooling - Required for Nx workspace and build configuration
- **1002**: Development Environment Setup - Related for local development and tooling

## Testing Plan

- Validate all CI/CD workflows execute successfully
- Test build automation with affected builds and caching
- Verify comprehensive test coverage and quality gates
- Test security scanning and vulnerability detection
- Validate deployment pipeline with blue-green strategy
- Test rollback mechanisms and monitoring
- Verify release management and semantic versioning

## Quality Gates

### Build Quality Gates
- All linting and formatting checks must pass
- TypeScript compilation must succeed without errors
- Unit test coverage must be â‰¥95%
- Integration test coverage must be â‰¥90%
- No high-severity security vulnerabilities
- Performance benchmarks must meet thresholds

### Deployment Quality Gates
- All quality gates must pass
- Security scans must show no critical vulnerabilities
- Health checks must pass in target environment
- Database migrations must complete successfully
- Smoke tests must pass post-deployment

## Configuration Files Summary

Key files created by this feature:
- `.github/workflows/ci.yml` - Main CI pipeline
- `.github/workflows/security.yml` - Security scanning
- `.github/workflows/deploy-*.yml` - Deployment pipelines
- `.github/workflows/performance.yml` - Performance testing
- `Dockerfile` templates for all services
- `docker-compose.ci.yml` - CI environment
- `.release.json` - Semantic release configuration
- Quality gate configurations

## Notes

- Optimize for fast feedback with parallel execution and caching
- Implement comprehensive security scanning at multiple stages
- Use blue-green deployments to minimize downtime
- Maintain high test coverage requirements for trading system reliability
- Consider implementing canary deployments for production releases
- Monitor pipeline performance and optimize bottlenecks regularly

## Status Updates

- **2025-08-24**: Feature specification created and documented