---
# ============================================================================
# SPEC METADATA - Task specification
# ============================================================================

# === IDENTIFICATION ===
id: '1042'
title: 'Main CI Pipeline Configuration'
type: 'task'

# === HIERARCHY ===
parent: '1004'
children: []
epic: '1000'
domain: 'infrastructure'

# === WORKFLOW ===
status: 'draft'
priority: 'high'

# === TRACKING ===
created: '2025-08-28'
updated: '2025-08-28'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === DEPENDENCIES ===
dependencies: ['1041'] # Requires GitHub Actions setup
blocks: ['1047', '1048']
related: ['1003'] # Nx monorepo structure

# === IMPLEMENTATION ===
pull_requests: []
commits: []
context_file: "1042.context.md"
files: ['.github/workflows/ci.yml', 'nx.json', 'jest.config.ts']

# === METADATA ===
tags: ['ci', 'pipeline', 'testing', 'quality', 'nx']
effort: 'medium'
risk: 'medium'

# ============================================================================
---

# Main CI Pipeline Configuration

## Overview

Implement the comprehensive CI pipeline workflow that runs on every push and pull request. This pipeline orchestrates code quality checks, testing, and builds using Nx's affected commands for optimal performance in the monorepo structure.

## Acceptance Criteria

- [ ] **Triggered Events**: Pipeline runs on push to main/develop and all PRs
- [ ] **Affected Detection**: Uses Nx to detect and build only affected projects
- [ ] **Parallel Execution**: Matrix strategy for parallel quality checks and tests
- [ ] **Code Quality Checks**: Linting, formatting, and type checking
- [ ] **Test Suites**: Unit, integration, and E2E tests with coverage
- [ ] **Build Validation**: Production builds for affected services
- [ ] **Coverage Gates**: 95% coverage requirement enforcement
- [ ] **Performance**: Optimal caching and parallelization

## Technical Implementation

### Main CI Workflow

**`.github/workflows/ci.yml`**:
```yaml
name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_BRANCH: ${{ github.event.number || github.ref_name }}
  NX_CLOUD_DISTRIBUTED_EXECUTION: true

jobs:
  # === SETUP AND ANALYSIS ===
  setup:
    name: Setup and Analyze
    runs-on: ubuntu-latest
    outputs:
      has-affected: ${{ steps.affected.outputs.has-affected }}
      affected-apps: ${{ steps.affected.outputs.affected-apps }}
      affected-libs: ${{ steps.affected.outputs.affected-libs }}
      cache-key: ${{ steps.cache-key.outputs.key }}
      base-sha: ${{ steps.base.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine Base SHA
        id: base
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=origin/main~1" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "key=node-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      
      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-${{ runner.os }}-
      
      - name: Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-
      
      - name: Analyze Affected Projects
        id: affected
        run: |
          AFFECTED_APPS=$(npx nx show projects --affected --type=app --base=${{ steps.base.outputs.sha }} | tr '\n' ',' | sed 's/,$//')
          AFFECTED_LIBS=$(npx nx show projects --affected --type=lib --base=${{ steps.base.outputs.sha }} | tr '\n' ',' | sed 's/,$//')
          HAS_AFFECTED=$([[ -n "$AFFECTED_APPS" || -n "$AFFECTED_LIBS" ]] && echo 'true' || echo 'false')
          
          echo "affected-apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT
          echo "affected-libs=$AFFECTED_LIBS" >> $GITHUB_OUTPUT
          echo "has-affected=$HAS_AFFECTED" >> $GITHUB_OUTPUT
          
          echo "📊 Analysis Results:"
          echo "  Apps: ${AFFECTED_APPS:-none}"
          echo "  Libs: ${AFFECTED_LIBS:-none}"
          echo "  Has Changes: $HAS_AFFECTED"

  # === CODE QUALITY ===
  code-quality:
    name: Code Quality (${{ matrix.check }})
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [lint, type-check, format]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Environment
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Restore Caches
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .nx/cache
          key: ${{ needs.setup.outputs.cache-key }}
      
      - name: Run Lint Check
        if: matrix.check == 'lint'
        run: |
          npx nx affected --target=lint \
            --parallel=3 \
            --base=${{ needs.setup.outputs.base-sha }} \
            --configuration=ci
      
      - name: Run Type Check
        if: matrix.check == 'type-check'
        run: |
          npx nx affected --target=type-check \
            --parallel=3 \
            --base=${{ needs.setup.outputs.base-sha }}
      
      - name: Check Formatting
        if: matrix.check == 'format'
        run: |
          npx nx format:check \
            --base=${{ needs.setup.outputs.base-sha }}

  # === TESTING ===
  test:
    name: Test (${{ matrix.test-type }})
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, e2e]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_pass
          POSTGRES_USER: test_user
          POSTGRES_DB: jts_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Environment
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Restore Caches
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .nx/cache
          key: ${{ needs.setup.outputs.cache-key }}
      
      - name: Run Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          npx nx affected --target=test \
            --configuration=ci \
            --parallel=3 \
            --base=${{ needs.setup.outputs.base-sha }} \
            --coverage \
            --coverageReporters=json,lcov,text-summary
      
      - name: Run Integration Tests
        if: matrix.test-type == 'integration'
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: |
          npx nx affected --target=integration-test \
            --parallel=2 \
            --base=${{ needs.setup.outputs.base-sha }}
      
      - name: Run E2E Tests
        if: matrix.test-type == 'e2e'
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/jts_test
          REDIS_URL: redis://localhost:6379
        run: |
          npx nx affected --target=e2e \
            --parallel=1 \
            --base=${{ needs.setup.outputs.base-sha }}
      
      - name: Upload Coverage
        if: matrix.test-type == 'unit' && github.event_name == 'pull_request'
        uses: codecov/codecov-action@v3
        with:
          directory: ./coverage
          flags: ${{ matrix.test-type }}
          fail_ci_if_error: false
          verbose: true
      
      - name: Coverage Quality Gate
        if: matrix.test-type == 'unit'
        run: |
          COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
          echo "📊 Coverage: $COVERAGE%"
          
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below required 95%"
            exit 1
          else
            echo "✅ Coverage $COVERAGE% meets requirement"
          fi

  # === BUILD VALIDATION ===
  build:
    name: Build Affected Services
    needs: [setup, code-quality, test]
    if: |
      always() && 
      needs.setup.outputs.has-affected == 'true' && 
      needs.code-quality.result == 'success' && 
      needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Environment
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Restore Caches
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .nx/cache
          key: ${{ needs.setup.outputs.cache-key }}
      
      - name: Build Affected Projects
        run: |
          npx nx affected --target=build \
            --configuration=production \
            --parallel=3 \
            --base=${{ needs.setup.outputs.base-sha }}
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # === FINAL STATUS ===
  ci-status:
    name: CI Status
    needs: [setup, code-quality, test, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.setup.outputs.has-affected }}" == "false" ]]; then
            echo "ℹ️ No affected projects detected - skipping CI"
            exit 0
          fi
          
          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
            echo "❌ Code quality checks failed"
            exit 1
          fi
          
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "❌ Tests failed"
            exit 1
          fi
          
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi
          
          echo "✅ CI Pipeline completed successfully"
```

### Nx Configuration for CI

**`nx.json` additions**:
```json
{
  "tasksRunnerOptions": {
    "default": {
      "runner": "@nrwl/nx-cloud",
      "options": {
        "cacheableOperations": [
          "build",
          "test",
          "lint",
          "type-check",
          "e2e"
        ],
        "accessToken": "{{NX_CLOUD_ACCESS_TOKEN}}",
        "parallel": 3,
        "cacheDirectory": ".nx/cache"
      }
    }
  },
  "targetDefaults": {
    "test": {
      "configurations": {
        "ci": {
          "ci": true,
          "coverage": true,
          "silent": true,
          "reporters": ["default", "jest-junit"]
        }
      }
    }
  }
}
```

### Jest Configuration for CI

**`jest.config.ci.js`**:
```javascript
module.exports = {
  ...require('./jest.config'),
  ci: true,
  coverage: true,
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'apps/**/*.ts',
    'libs/**/*.ts',
    '!**/*.spec.ts',
    '!**/*.e2e-spec.ts',
    '!**/node_modules/**',
    '!**/dist/**',
  ],
  coverageThreshold: {
    global: {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95
    }
  },
  reporters: [
    'default',
    ['jest-junit', {
      outputDirectory: 'test-results',
      outputName: 'junit.xml',
    }]
  ]
};
```

## Testing Plan

- Test with various change scenarios (single app, multiple apps, libs only)
- Verify affected detection accuracy
- Validate parallel execution improves performance
- Test coverage gate enforcement
- Verify build artifacts are correctly generated

## Success Metrics

- Pipeline execution time <10 minutes for average PR
- Affected detection reduces unnecessary builds by >60%
- Coverage consistently maintained above 95%
- Zero false positives in quality checks

## Notes

- Use Nx Cloud for distributed caching across CI runs
- Consider adding branch-specific configurations
- Monitor pipeline performance and optimize bottlenecks
- Add PR comment integration for coverage reports