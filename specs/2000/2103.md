---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: '2103' # Numeric ID for stable reference
title: 'Creon Windows COM Integration Service'
type: 'feature' # prd | epic | feature | task | subtask | bug | spike

# === HIERARCHY ===
parent: '2000' # Parent spec ID (broker integration epic)
children: [] # Child spec IDs (if any)
epic: '2000' # Root epic ID for this work
domain: 'broker-creon' # Business domain

# === WORKFLOW ===
status: 'draft' # draft | reviewing | approved | in-progress | testing | done
priority: 'high' # high | medium | low

# === TRACKING ===
created: '2025-08-25' # YYYY-MM-DD
updated: '2025-08-25' # YYYY-MM-DD
due_date: '' # YYYY-MM-DD (optional)
estimated_hours: 35 # Time estimate in hours
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: ['2100'] # Must be done before this (unified broker interface)
blocks: [] # This blocks nothing directly
related: ['2104', '2108'] # Related to rate limiting and error handling

# === IMPLEMENTATION ===
branch: '' # Git branch name
files: ['apps/brokers/creon/', 'deployment/creon-windows/', 'libs/shared/adapters/creon-adapter.ts'] # Key files to modify

# === METADATA ===
tags: ['creon', 'windows', 'com', 'korean-market', 'fastapi'] # Searchable tags
effort: 'large' # small | medium | large | epic
risk: 'high' # low | medium | high (Windows dependency, COM complexity)

# ============================================================================
---

# Creon Windows COM Integration Service

## Overview

Create a FastAPI wrapper service for Creon COM objects running on a dedicated Windows PC with network API exposure. This feature enables integration with Creon's powerful Korean market trading platform, which requires Windows-specific COM objects and cannot run in containers or virtual machines due to security restrictions. The service provides REST API access to Creon functionality while handling the extreme rate limits (15 requests per 60 seconds).

## Acceptance Criteria

- [ ] FastAPI service wrapping Creon COM objects implemented
- [ ] Windows bare-metal deployment configured and operational
- [ ] Session management with automatic login/logout handling
- [ ] All critical Creon trading APIs wrapped and exposed
- [ ] Rate limiting enforcement (15 requests per 60 seconds)
- [ ] REST endpoints accessible from main Linux system
- [ ] Connection monitoring and health checks implemented
- [ ] Error handling for COM object failures
- [ ] Automatic session recovery after disconnections
- [ ] Historical data access APIs functional
- [ ] Real-time data bridge operational
- [ ] Secure network communication established
- [ ] Memory leak prevention with periodic restarts
- [ ] Comprehensive logging and monitoring

## Technical Approach

### Architecture Design

Deploy a Python FastAPI service directly on a dedicated Windows PC that interfaces with Creon COM objects and exposes functionality through REST APIs. The service acts as a bridge between the Windows-only Creon platform and the main Linux-based trading system.

### Key Components

1. **Creon COM Wrapper**
   - COM object initialization and lifecycle management
   - Method wrapping for all trading operations
   - Event handler registration for real-time updates
   - Memory management and cleanup
   - COM error handling and recovery

2. **FastAPI Service Layer**
   - REST endpoint definitions
   - Request validation and serialization
   - Response formatting and error codes
   - API documentation (OpenAPI/Swagger)
   - CORS configuration for cross-origin requests

3. **Session Management**
   - Automatic Creon login on startup
   - Session state monitoring
   - Periodic keep-alive operations
   - Graceful logout on shutdown
   - Credential secure storage

4. **Rate Limiting Handler**
   - Strict 15 req/60s enforcement
   - Request queue management
   - Priority-based request processing
   - Rate limit status reporting
   - Buffer maintenance (20% safety margin)

5. **Network Security**
   - HTTPS with SSL certificates
   - API key authentication
   - IP whitelist enforcement
   - Request signing/validation
   - Audit logging

### Implementation Steps

1. **Setup Windows Environment**
   - Configure dedicated Windows PC
   - Install Creon Plus API
   - Setup Python environment
   - Configure Windows Firewall rules
   - Install monitoring tools

2. **Create COM Wrapper Layer**
   - Initialize pythoncom and win32com
   - Create Creon object factories
   - Implement method wrappers
   - Add event handlers
   - Handle COM threading model

3. **Build FastAPI Service**
   - Define API routes structure
   - Create request/response models
   - Implement endpoint handlers
   - Add validation middleware
   - Configure error handling

4. **Implement Core Trading APIs**
   - Order placement wrapper
   - Order status inquiry
   - Position query
   - Balance retrieval
   - Market data access

5. **Add Session Management**
   - Login automation
   - Connection monitoring
   - Heartbeat implementation
   - Recovery mechanisms
   - Logout procedures

6. **Deploy and Secure**
   - Configure Windows service
   - Setup SSL certificates
   - Implement authentication
   - Configure network access
   - Setup monitoring

## Creon Specifications

### Platform Requirements
- **OS**: Windows 10/11 Professional (bare metal)
- **Hardware**: Dedicated PC with static IP
- **Software**: Creon Plus API, Python 3.8+
- **Network**: Low-latency LAN connection (<5ms)
- **Memory**: 8GB minimum, 16GB recommended

### Rate Limits
- **Primary Limit**: 15 requests per 60 seconds
- **Safety Buffer**: Maintain 20% reserve (12 req/60s)
- **Queue Depth**: Maximum 100 pending requests
- **Priority Levels**: Critical, High, Normal, Low

### API Categories
- **Trading**: Order management, executions
- **Account**: Balance, positions, history
- **Market Data**: Quotes, charts, orderbook
- **System**: Status, configuration, health

## Trading-Specific Requirements

### Order Management
- Support Korean order types compatible with Creon
- Handle Creon-specific order codes and statuses
- Map Creon errors to unified error system
- Preserve order IDs across systems
- Track partial fills accurately

### Session Reliability
- Automatic login retry on failure
- Session timeout detection
- Market hours awareness
- Holiday calendar integration
- Maintenance window handling

### Performance Optimization
- Request batching where possible
- Response caching for static data
- Connection pooling for COM objects
- Memory usage monitoring
- Periodic service restart scheduling

## Windows Deployment

### Hardware Setup
```
- Dedicated Windows PC (no virtualization)
- Static IP address configuration
- UPS power backup recommended
- Remote management capability (RDP)
- Hardware monitoring sensors
```

### Software Configuration
```
- Windows 10/11 Professional
- Creon Plus API latest version
- Python 3.8+ with FastAPI
- Windows Service wrapper
- Monitoring agents
```

### Network Security
```
- Firewall rules for API access only
- VPN connection to main system
- SSL/TLS encryption mandatory
- Regular security updates
- Access logging and alerting
```

## Dependencies

- **2100**: Unified Broker Interface - Must implement IBroker interface
- **2104**: Rate Limiting System - Coordinates with global rate limiter
- **2108**: Error Handling - Integrates with error recovery system

## Testing Plan

- Unit tests for COM wrapper methods
- Integration tests with Creon test account
- Rate limit compliance verification
- Network latency measurements
- Session recovery testing
- Memory leak detection over 24 hours
- Stress testing with maximum load
- Failover scenario validation
- Security penetration testing

## Claude Code Instructions

```
When implementing this feature:
1. Use Python 3.8+ with FastAPI framework
2. Install pywin32 for COM object access
3. Use pythoncom.CoInitialize() for COM threading
4. Implement proper COM object cleanup to prevent leaks
5. Create Windows service using python-windows-service
6. Use asyncio for non-blocking operations where possible
7. Implement circuit breaker for COM failures
8. Add comprehensive exception handling for COM errors
9. Use environment variables for credentials
10. Create health check endpoint that verifies Creon connection
11. Implement request queuing with priority levels
12. Log all operations for audit and debugging
13. Monitor Windows Event Log for Creon errors
14. Setup automatic restart schedule (daily at 6 AM)
15. Use Redis for request queue if available on Windows
```

## Risk Mitigation

### Single Point of Failure
- **Risk**: Windows PC failure disrupts all Creon trading
- **Mitigation**: Hot standby PC with rapid switchover capability

### Rate Limit Violations
- **Risk**: Exceeding 15 req/60s causes API suspension
- **Mitigation**: Conservative limit (12 req/60s), priority queuing

### Memory Leaks
- **Risk**: COM objects can leak memory over time
- **Mitigation**: Daily service restart, memory monitoring

### Network Security
- **Risk**: Exposed Windows PC vulnerable to attacks
- **Mitigation**: Strict firewall rules, VPN-only access

## Notes

- Creon cannot run in Docker/VM due to security restrictions
- Windows PC must be bare metal with Creon installed
- Rate limits are extremely strict - violations suspend access
- COM objects require specific threading model (STA)
- Some Creon features require Korean Windows locale
- Consider redundant Windows PC for high availability
- Creon sessions expire after market hours
- Windows updates can disrupt service - schedule carefully

## Status Updates

- **2025-08-25**: Feature spec created and documented