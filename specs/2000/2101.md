---
# ============================================================================
# SPEC METADATA - This entire frontmatter section contains the spec metadata
# ============================================================================

# === IDENTIFICATION ===
id: '2101' # Numeric ID for stable reference
title: 'KIS REST API Integration'
type: 'feature' # prd | epic | feature | task | subtask | bug | spike

# === HIERARCHY ===
parent: '2000' # Parent spec ID (broker integration epic)
children: [] # Child spec IDs (if any)
epic: '2000' # Root epic ID for this work
domain: 'broker-kis' # Business domain

# === WORKFLOW ===
status: 'draft' # draft | reviewing | approved | in-progress | testing | done
priority: 'high' # high | medium | low

# === TRACKING ===
created: '2025-08-25' # YYYY-MM-DD
updated: '2025-08-25' # YYYY-MM-DD
due_date: '' # YYYY-MM-DD (optional)
estimated_hours: 40 # Time estimate in hours
actual_hours: 0 # Time spent so far

# === DEPENDENCIES ===
dependencies: ['2100'] # Must be done before this (unified broker interface)
blocks: ['2102'] # This blocks KIS WebSocket feature
related: ['2104', '2105'] # Related to rate limiting and account management

# === IMPLEMENTATION ===
branch: '' # Git branch name
files: ['apps/brokers/kis/', 'brokers/kis/KIS_API_SPEC.md', 'libs/shared/adapters/kis-adapter.ts'] # Key files to modify

# === METADATA ===
tags: ['kis', 'rest-api', 'oauth2', 'korean-market', 'trading'] # Searchable tags
effort: 'large' # small | medium | large | epic
risk: 'medium' # low | medium | high (external API dependency)

# ============================================================================
---

# KIS REST API Integration

## Overview

Full integration with Korea Investment Securities (KIS) REST API covering all 337 endpoints including authentication, trading, market data, and account management. This feature implements comprehensive support for Korean stock market operations through KIS's OpenAPI platform, handling OAuth2 authentication, secure order placement with hashkey generation, and multi-environment support for both production and sandbox testing.

## Acceptance Criteria

- [ ] OAuth2 authentication flow implemented with automatic 24-hour token refresh
- [ ] All 337 KIS REST APIs integrated and tested
- [ ] Hashkey generation for secure order operations (HMAC-SHA256)
- [ ] Trading APIs fully functional (order placement, modification, cancellation)
- [ ] Market data APIs operational (quotes, orderbook, historical data)
- [ ] Account management APIs working (balance, positions, trading history)
- [ ] Rate limiting compliance (20 req/sec, 1,000 req/min, 50,000 req/hour)
- [ ] Both production and sandbox environment support
- [ ] Comprehensive error handling with all 50+ KIS error codes mapped
- [ ] Request/response logging for audit compliance
- [ ] Performance metrics meet targets (<50ms order placement)
- [ ] 95% test coverage with integration tests

## Technical Approach

### API Integration Architecture

Implement a comprehensive KIS service using NestJS that wraps all 337 KIS REST APIs with proper authentication, rate limiting, and error handling. The service will use the Adapter pattern to conform to the IBroker interface while maintaining KIS-specific functionality.

### Key Components

1. **Authentication Service**
   - OAuth2 token management with refresh logic
   - Hashkey generation for secure transactions
   - Token storage and rotation
   - Multi-account credential management
   - Environment-specific authentication

2. **Trading API Module**
   - Order placement (all 8 Korean order types)
   - Order modification and cancellation
   - Order status inquiry
   - Execution history retrieval
   - Multi-market support (KOSPI, KOSDAQ)

3. **Market Data Module**
   - Real-time price quotes
   - Orderbook depth (10 levels)
   - Historical price data
   - Market statistics
   - Trading halts and circuit breakers

4. **Account Management Module**
   - Balance inquiry (cash, securities)
   - Position tracking
   - Transaction history
   - Buying power calculation
   - Account restrictions and limits

5. **Rate Limiting Integration**
   - Request throttling per limits
   - Priority queue for critical operations
   - Request batching optimization
   - Rate limit monitoring

### Implementation Steps

1. **Setup KIS Service Structure**
   - Create NestJS service in apps/brokers/kis
   - Configure environment variables for API keys
   - Setup HTTP client with interceptors
   - Implement request/response logging

2. **Implement Authentication**
   - OAuth2 token acquisition endpoint
   - Token refresh scheduler (every 23 hours)
   - Hashkey generation for orders
   - Secure credential storage
   - Token validation middleware

3. **Build Trading APIs**
   - Implement all order-related endpoints
   - Add order type validation
   - Create order status tracking
   - Handle partial fills
   - Implement order amendment logic

4. **Integrate Market Data APIs**
   - Create market data service
   - Implement data caching layer
   - Add data normalization
   - Handle market hours validation
   - Support multiple symbol formats

5. **Develop Account APIs**
   - Balance aggregation logic
   - Position calculation
   - P&L computation
   - Transaction history parsing
   - Buying power validation

6. **Add Error Handling**
   - Map all KIS error codes
   - Implement retry logic
   - Add circuit breaker pattern
   - Create fallback strategies
   - Log errors for analysis

## API Resources

### Endpoints Coverage
- **Stock Trading**: 87 APIs
- **Futures/Options**: 62 APIs
- **International Markets**: 45 APIs
- **Market Data**: 78 APIs
- **Account Management**: 42 APIs
- **System/Utility**: 23 APIs
- **Total**: 337 APIs

### Environment URLs
- **Production**: `https://openapi.koreainvestment.com:9443`
- **Sandbox**: `https://openapivts.koreainvestment.com:29443`
- **WebSocket**: Separate feature (2102)

### Rate Limits
- **Per Second**: 20 requests
- **Per Minute**: 1,000 requests
- **Per Hour**: 50,000 requests
- **Token Validity**: 24 hours

## Trading-Specific Requirements

### Order Management
- Support all Korean order types: Market, Limit, Market on Close, Limit on Close, Conditional, Best Limit, IOC, FOK
- Handle order states: Pending, Submitted, Partial Fill, Filled, Cancelled, Rejected, Expired
- Track order amendments with version history
- Implement pre-trade validation

### Market Compliance
- Enforce Korean trading hours (09:00-15:30 KST)
- Handle pre-market (08:30-09:00) and after-hours (15:30-18:00) sessions
- Respect circuit breakers and trading halts
- Validate tick sizes and lot sizes per symbol

### Performance Requirements
- Order placement: <50ms latency
- Market data query: <100ms
- Balance inquiry: <200ms
- Bulk operations: <500ms

## Dependencies

- **2100**: Unified Broker Interface Foundation - Must implement IBroker interface
- **2104**: Rate Limiting System - Will integrate for request throttling
- **2105**: Account Pool Management - Will support multi-account operations

## Testing Plan

- Unit tests for all API methods
- Integration tests with KIS sandbox environment
- Load testing for rate limit compliance
- Mock server for offline development
- End-to-end trading scenario tests
- Performance benchmarks for latency requirements
- Error handling scenario tests
- Multi-account coordination tests

## Claude Code Instructions

```
When implementing this feature:
1. Start by reviewing brokers/kis/KIS_API_SPEC.md for API documentation
2. Reference brokers/kis/reference/KIS_API_20250817_030000.xlsx for detailed specs
3. Use NestJS HttpModule for API calls with proper interceptors
4. Implement comprehensive request/response logging
5. Store API credentials in environment variables only
6. Use Redis for token caching and rate limit tracking
7. Create DTOs for all request/response types with validation
8. Implement proper HMAC-SHA256 for hashkey generation
9. Add health check endpoints for monitoring
10. Use exponential backoff for retry logic
11. Create separate modules for different API categories
12. Ensure all monetary values handle KRW properly
13. Test thoroughly in sandbox before production
```

## Notes

- KIS API documentation is extensive - refer to Excel spec for complete details
- Hashkey is critical for order security - must be implemented correctly
- Rate limits are strict - violations can result in API suspension
- Sandbox environment has same limits as production
- Some APIs have different responses between sandbox and production
- Market data rights may require additional licensing
- Consider implementing request coalescing for efficiency

## Status Updates

- **2025-08-25**: Feature spec created and documented